pipeline {
    agent {
        label 'skyvera-jenkins-protractor'
    }
	parameters {
        string(name: 'TargetHost', defaultValue: '10.25.2.82', description: 'Target host to deploy to')
		string(name: 'fullHostName', defaultValue: 'tenant01.epmldev.com', description: 'Target full host name')
    }
    stages {
        stage('Preparing for UI tests execution') {
            steps {
                echo 'Set scripts permissions...'
                sh "chmod +x ${env.WORKSPACE}/BuildJenkins/Protractor/*.sh"
                
                echo 'Installing dependencies...'
                dir ("${env.WORKSPACE}/EMPLiveAutomationTesting/protractor") {
                    sh "${env.WORKSPACE}/BuildJenkins/Protractor/install-dependencies.sh"
                }
                
                echo 'Updating hosts file...'
                dir ("${env.WORKSPACE}/EMPLiveAutomationTesting/protractor") {
                    sh "${env.WORKSPACE}/BuildJenkins/Protractor/update-hosts-file.sh ${params.TargetHost} ${params.fullHostName}"
                }
            }
        }
        stage('Executing UI tests') {
            steps {
                echo 'Run tests...'
                dir ("${env.WORKSPACE}/EMPLiveAutomationTesting/protractor") {
                    sh "npm install; npm run e2e-tc -- --params.headlessBrowser=true"
                }
            }
        }
    }
    post {
        always {
            echo 'Generating Allure report...'
            script {
                allure([
                    includeProperties: false,
                    jdk: '',
                    properties: [],
                    reportBuildPolicy: 'ALWAYS',
                    results: [[path: "EMPLiveAutomationTesting/protractor/auto-generated/allure-results"]]
                ])
            }
        }
    }
}
