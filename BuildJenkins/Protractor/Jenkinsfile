pipeline {
    agent {
        label 'skyvera-jenkins-protractor'
    }
  
    stages {
        stage('Preparing for UI tests execution') {
            steps {
                echo 'Set scripts permissions...'
                sh "chmod +x ${env.WORKSPACE}/BuildJenkins/Protractor/*.sh"
                
                echo 'Installing dependencies...'
                dir ("${env.WORKSPACE}/TestSuite.Protractor") {
                    sh "${env.WORKSPACE}/BuildJenkins/Protractor/install-dependencies.sh"
                }
                
                echo 'Updating hosts file...'
                dir ("${env.WORKSPACE}/TestSuite.Protractor") {
                    sh "${env.WORKSPACE}/BuildJenkins/Protractor/update-hosts-file.sh"
                }
            }
        }
        stage('Executing UI tests') {
            steps {
                echo 'Run tests...'
                dir ("${env.WORKSPACE}/TestSuite.Protractor") {
                    sh "npm run e2e-tc -- --params.headlessBrowser=true"
                }
            }
        }
    }
    post {
        always {
            echo 'Generating Allure report...'
            script {
                allure([
                    includeProperties: false,
                    jdk: '',
                    properties: [],
                    reportBuildPolicy: 'ALWAYS',
                    results: [[path: "TestSuite.Protractor/auto-generated/allure-results"]]
                ])
            }
        }
    }
}