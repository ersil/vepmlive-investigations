(function(){function n(){(function(n,t,i,r){function u(t,i){for(var f=[],e=i==="old",r,u=0;u<n.notifications().length;u++)r=n.notifications()[u],r.notificationread()===e&&(t==="system"?(r.type()===0||r.type()===1)&&f.push(r):r.type()>1&&f.push(r));return f}function l(t){for(var r,i=0;i<n.notifications().length;i++)if(r=n.notifications()[i],r.id()===t)return r;return null}function s(t,i){for(var f=[],e=i==="old",r,u=0;u<n.invisibleNotifications().length;u++)r=n.invisibleNotifications()[u],r.notificationread()===e&&(t==="system"?(r.type()===0||r.type()===1)&&f.push(r):r.type()>1&&f.push(r));return f}function e(){return n.showNotifications()}function a(){var n=i("#EPMLiveNotificationCounter");i(n).fadeTo(400,.25,function(){i(n).fadeTo(400,1)})}function o(){i("#EPMLiveNotificationsWrap").height(0);var t=i("#EPMLiveNotificationGeneral").parent()[0];t.className!=="slimScrollDiv"?i("#EPMLiveNotificationGeneral").slimScroll({height:n.generalNotificationHeight()}):(i(t).height(n.generalNotificationHeight()),i("#EPMLiveNotificationGeneral").height(n.generalNotificationHeight()));i("#EPMLiveNotificationsWrap").css("height","auto");i("#EPMLiveNotificationGeneral").endlessScroll({callback:function(){n.retrieveMoreNotifications("GENERAL","OLD")}})}function h(t){if(e()){var r=t||i("#EPMLiveNotificationCounter");n.showNotifications(!1);n.updateNotifications();n.activeView("notification");r.css("background","#666666");r.css("color","#fff");r.css("font-weight",n.notificationCounterFontWeight())}}function c(){var n=i("#EPMLiveNotificationsWrap");n?(clearInterval(f),n.remove(),i("body").append(n),n.css("right",t.getScrollbarWidth()+5),i("html").click(function(){h()}),i("#EPMLiveNotificationsWrap").click(function(n){n.stopPropagation()}),i("#EPMLiveNotificationCounter").click(function(n){n.stopPropagation()}),i("#EPMLiveNotificationCounterProfilePic").click(function(n){n.stopPropagation()})):f=setTimeout(c,1)}function v(){var t=i("#EPMLiveNotificationCounter"),r=function(){e()?h(t):(t.css("background","#D0D0D0"),t.css("color","#000"),t.css("font-weight",""),n.showNotifications(!0),o(),n.totalNewNotifications()>0&&n.markMessagesAsRead(),window.setTimeout(function(){i("#EPMLiveNotificationsWrap").show()},1))};t.click(function(){r()});i("#EPMLiveNotificationCounterProfilePic").click(function(){r()});f=setTimeout(c,1)}var f=null;n.notifications=r.observableArray();n.invisibleNotifications=r.observableArray();n.totalNewNotifications=r.observable(0);n.activeNotification=r.observable(null);n.updatedNotifications=[];n.activeView=r.observable("notification");n.showNotifications=r.observable(!1);n.firstTimeLoad=!0;n.lastTimestamp=0;n.notificationDisplayLimit=3;n.notificationQueryLimit=r.dependentObservable(function(){return n.notificationDisplayLimit*5},n);n.notificationFirstPage=r.observable(0);n.notificationLastPage=r.dependentObservable(function(){return n.notificationFirstPage()+n.notificationQueryLimit()},n);n.postNotificationMessageDisplay=function(n){var r=500,f=3,t,u;i.browser.msie&&(f=2);t=n[f];t&&i(t).height()>=r&&(u=i(t).parent()[0],u.className!=="slimScrollDiv"?i(t).slimScroll({height:r}):(i(u).height(r),i(t).height(r)))};n.newSystemNotifications=r.dependentObservable(function(){return u("system","new")},n);n.oldSystemNotifications=r.dependentObservable(function(){return u("system","old")},n);n.newGeneralNotifications=r.dependentObservable(function(){return u("general","new")},n);n.oldGeneralNotifications=r.dependentObservable(function(){return u("general","old")},n);n.totalSystemNotifications=r.dependentObservable(function(){return n.newSystemNotifications().length+n.oldSystemNotifications().length},n);n.totalGeneralNotifications=r.dependentObservable(function(){return n.newGeneralNotifications().length+n.oldGeneralNotifications().length},n);n.notificationCounterColor=r.dependentObservable(function(){return e()?"#D0D0D0":this.newSystemNotifications().length>0?"#89CE00":this.newGeneralNotifications().length>0?"#26C6F4":"#666666"},n);n.notificationCounterFontWeight=r.dependentObservable(function(){return this.totalNewNotifications()>0?"bold":""},n);n.generalNotificationHeight=r.dependentObservable(function(){var t=600,r=60,f=n.totalGeneralNotifications(),u=n.totalSystemNotifications(),i;return u>0&&(t=t-r-u*55),t=t-r,i=f*55,(i<t?i:t)+"px"},n);n.getMoreNotifications=function(t,i){var f,r,u;for(t=t.toLowerCase(),i=i.toLowerCase(),f=s(t,i),r=0;r<n.notificationDisplayLimit;r++)u=f[r],u&&(n.notifications.push(u),n.invisibleNotifications.remove(u));return s(t,i).length>=n.notificationDisplayLimit?!0:!1};n.notifications.exists=function(n){for(var t=0;t<this().length;t++)if(this()[t].id()===n.id())return!0;return!1};n.invisibleNotifications.exists=function(n){for(var t=0;t<this().length;t++)if(this()[t].id()===n.id())return!0;return!1};n.registerNotification=function(t){var i=!1;i=t.notificationread()?t.type()>1?!1:!0:!0;n.notifications.exists(t)||n.invisibleNotifications.exists(t)||(i?(n.notifications.unshift(t),t.notificationread()||(n.totalNewNotifications(parseInt(n.totalNewNotifications())+1),n.firstTimeLoad||a())):n.invisibleNotifications.unshift(t))};n.messageTypeImage=function(i){var r=n.messageTypeImageCollection[i];return r?"url('"+t.currentWebFullUrl+"/_layouts/epmlive/images/notification-icons/"+r+".png') no-repeat scroll center center":null};n.postMessageInfoRender=function(n){i(n[3]).click(function(n){n.stopPropagation()})};n.updateNotifications=function(){if(n.updatedNotifications.length>0){for(var t=0;t<n.updatedNotifications.length;t++)l(n.updatedNotifications[t]).notificationread(!0);n.updatedNotifications=[]}n.totalNewNotifications(0)};n.markMessagesAsRead=function(){for(var f='<Notifications MarkAllRead="true"><Notification ID="" Type="0"><Flag Type="READ" Value="true"/><\/Notification>',u,e=[],s=n.newSystemNotifications(),o,r=0;r<s.length;r++)u=s[r],f+='<Notification ID="'+u.id()+'" Type="'+u.type()+'"><Flag Type="READ" Value="true"/><\/Notification>',e.push(u.id());for(o=n.newGeneralNotifications(),r=0;r<o.length;r++)u=o[r],f+='<Notification ID="'+u.id()+'" Type="'+u.type()+'"><Flag Type="READ" Value="true"/><\/Notification>',e.push(u.id());f+="<\/Notifications>";i.ajax({type:"POST",url:t.currentWebUrl+"/_vti_bin/WorkEngine.asmx/Execute",data:"{ Function: 'SetNotificationFlags', Dataxml: '"+f+"' }",contentType:"application/json; charset=utf-8",dataType:"json",success:function(i){if(i.d){var r=t.parseJson(i.d);t.responseIsSuccess(r.Result)?n.updatedNotifications=e:t.logFailure(r.Result)}else t.log("response.d: "+i.d)},error:function(n){t.log(n)}})};n.viewMessage=function(t){for(var r,i=0;i<n.notifications().length;i++)if(r=n.notifications()[i],r.id()===t){n.activeNotification(r);n.activeView("message");o();break}};n.viewNotifications=function(){n.activeView("notification");o()};n.init=function(){v()}})(window.epmLiveNotifications=window.epmLiveNotifications||{},epmLive,window.jQuery,ko)}ExecuteOrDelayUntilScriptLoaded(n,"EPMLive.js")})();
//# sourceMappingURL=EPMLive.Notifications.min.js.map