Create PROCEDURE [dbo].[spGetWorkspaces]
      @UserId AS INT,
      @SiteId AS UNIQUEIDENTIFIER,
      @View AS varchar(50)  
AS
BEGIN
      SET NOCOUNT ON;

	CREATE TABLE #Groups (GroupId INT)
	INSERT INTO #Groups (GroupId) SELECT GROUPID FROM dbo.RPTGROUPUSER WHERE (USERID = @UserId) AND (SITEID = @SiteId)
    
	IF @View = 'MyWorkspace'
	BEGIN  
		SELECT DISTINCT dbo.RPTWeb.SiteId,dbo.RPTWeb.Webtitle,dbo.RPTWeb.WebDescription,dbo.RPTWeb.WebId,dbo.RPTWeb.Members,dbo.LSTResourcepool.SharePointAccountText,
			CASE 
				WHEN @UserId = 1073741823 THEN 1 
				WHEN (dbo.RPTWeb.WebId IN (SELECT WEBID FROM dbo.RPTWEBGROUPS 
				WHERE (SECTYPE = 1) AND (GROUPID IN (SELECT GroupId FROM #Groups)) 
				OR (SECTYPE = 0) AND (GROUPID = @UserId))) THEN 1
			ELSE 0 
			END AS HasAccess
		FROM dbo.RPTWeb INNER JOIN dbo.LSTResourcepool ON dbo.RPTWeb.WebOwnerId = dbo.LSTResourcepool.SharePointAccountID 
		WHERE dbo.RPTWeb.SiteId = @SiteId AND dbo.RPTWeb.WebOwnerId= @UserId order by dbo.RPTWeb.WebTitle
	END
	ELSE IF @View = 'AllItems'
	BEGIN
		SELECT DISTINCT dbo.RPTWeb.SiteId,dbo.RPTWeb.Webtitle,dbo.RPTWeb.WebDescription,dbo.RPTWeb.WebId,dbo.RPTWeb.Members,dbo.LSTResourcepool.SharePointAccountText,
			CASE 
				WHEN @UserId = 1073741823 THEN 1 
				WHEN (dbo.RPTWeb.WebId IN (SELECT WEBID FROM dbo.RPTWEBGROUPS 
				WHERE (SECTYPE = 1) AND (GROUPID IN (SELECT GroupId FROM #Groups)) 
				OR (SECTYPE = 0) AND (GROUPID = @UserId))) THEN 1
			ELSE 0 
			END AS HasAccess
		FROM dbo.RPTWeb 
		INNER JOIN dbo.LSTResourcepool ON dbo.RPTWeb.WebOwnerId = dbo.LSTResourcepool.SharePointAccountID 
		WHERE dbo.RPTWeb.SiteId = @SiteId order by dbo.RPTWeb.WebTitle
	END   
END

