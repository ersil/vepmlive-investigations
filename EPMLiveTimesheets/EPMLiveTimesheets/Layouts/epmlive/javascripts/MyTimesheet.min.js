function TSOnLoaded(n){var i=n.id.substr(2),t=eval("TSObject"+i);n.Lang.Format.DecimalSeparator=t.DecimalSeparator;n.Lang.Format.GroupSeparator=t.GroupSeparator}function TMFilter(n,t){$("#ddlFilterControl_ul_menu").toggle();var i=Grids["TS"+n],r=i.Source;LoadGenericMenu=!1;t==1?(r.Data.Param.Dataxml=DataXML,i.Reload(r,null,null)):(r.Data.Param.Dataxml=DataXML.replace("/&gt"," Filter=&quot;"+t+"&quot;/&gt"),i.Source.Data.Param.Filter=t,i.Reload(r,null,null))}function EmailTSA(n){var i=Grids["TS"+n],r=i.GetSelRows(),t="";for(var u in r)t+=","+r[u].ResId;t.length>2&&(t=t.substr(1));var f=window.epmLiveNavigation.currentWebUrl,e=i.id.substr(2),o=eval("TSObject"+e),s=f+"/_layouts/epmlive/sendtsemail.aspx?period="+o.CurPeriodId+"&resources="+t,h={url:s,width:600,title:"Send Email",autoSize:!1};SP.UI.ModalDialog.showModalDialog(h)}function Approve(n){ProcessApprovals(n,"1")}function Reject(n){ProcessApprovals(n,"2")}function Unlock(n){ProcessApprovals(n,"0")}function ProcessApprovals(n,t){var r=Grids["TS"+n],i=r.GetSelRows(),f,u;if(i.length<=0)alert("You must select 1 or more rows");else{f="";for(u in i)i[u].Submitted=="1"&&(f+='<TS id="'+i[u].id+'">'+r.GetValue(i[u],"ApprovalNotes")+"<\/TS>");ShowMessage(r.id,"Processing Timesheets...",200,50);EPMLiveCore.WorkEngineAPI.Execute("timesheet_ApproveTimesheets",'<Approve ApproveStatus="'+t+'">'+f+"<\/Approve>",function(n){if(n=parseJson(n),n.Result["@Status"]=="0")for(var u in i)i[u].Submitted=="1"&&(r.SetValue(i[u],"Approved",t,1),r.RefreshCell(i[u],"TMApproval"));else alert(n.Result.Error["#text"]);HideMessage(r.id)})}}function GetTSGridId(n){return n.id.substr(2)}function LoadTSGrid(n){EPM.UI.Loader.current().startLoading({id:"WebPart"+eval("TSObject"+n+".Qualifier")})}function TSReady(n){var t=GetTSGridId(n);GridType=="0"?(TGSetEvent("OnDblClickRow",n.id,TSDoubleClick),TGSetEvent("OnFocus",n.id,TSOnFocus)):TGSetEvent("OnFocus",n.id,TSAOnFocus);TGSetEvent("OnGetHtmlValue",n.id,MYTSOnGetHtmlValue);TGSetEvent("OnMouseOutRow",n.id,TSOnMouseOutRow);TGSetEvent("OnMouseOverOutside",n.id,TSOnMouseOverOutside);TGSetEvent("OnMouseOverRow",n.id,TSOnMouseOverRow);TGSetEvent("OnClick",n.id,TSGridClick);TGSetEvent("OnAfterValueChanged",n.id,TSGridOnAfterValueChanged);TGSetEvent("OnSave",n.id,TSSave)}function TSSave(n,t){var t=n.GetRowById("-1"),i=!0;for(var r in TSDCols){var u=parseFloat(n.GetValue(t,r)),f=TSDCols[r].split("|"),e=parseFloat(f[0]),o=parseFloat(f[1]);u>o&&(alert("On "+n.GetValue(n.GetRowById("Header"),r).replace("<br>"," ")+": "+u+" is greater than max of "+o),i=!1);u<e&&(alert("On "+n.GetValue(n.GetRowById("Header"),r).replace("<br>"," ")+": "+u+" is smaller than min of "+e),i=!1)}return i?TimesheetHoursEdited=!1:HideMessage(n.id),!i}function TSGridClick(n,t,i){if(n.EditRow&&StopEditGridRow(n,t),NotesOut&&curCol!=i){NotesOut=!1;curPop=!1;var r=document.getElementById("NotesDiv");r.style.display="none"}curPop||DoPopUp(n,t,i)}function TSGridOnAfterValueChanged(n,t,i){n.Cols[i]!=null&&n.Cols[i]!=undefined&&(n.Cols[i].Sec==0?TimesheetItemEdited=!0:TimesheetHoursEdited=!0)}function StopEditCols(n,t){for(var i in n.Cols)n.Cols[i].Sec==0&&n.SetAttribute(t,i,"CanEdit","0",1);n.SetAttribute(t,"Title","HtmlPrefix","",1);n.EditRow="";TimesheetItemEdited=!1}function GetOtherHours(n,t){n.SetAttribute(t,"Title","HtmlPrefix","<img src='/_layouts/15/epmlive/images/mywork/loading16.gif'>",1);var i=window.epmLiveNavigation.currentWebUrl,r='<Timesheet List="'+t.ListID+'" ID="'+t.ItemID+'"/>';$.ajax({type:"POST",url:(i+"/_vti_bin/WorkEngine.asmx/ExecuteJSON").replace(/\/\//g,"/"),data:"{ Function: 'timesheet_GetOtherHours', Dataxml: '"+r+"' }",contentType:"application/json; charset=utf-8",dataType:"json",success:function(i){var r=eval("("+i.d+")");r.GetOtherHours.Status=="0"?n.SetValue(t,"TSOtherHours",r.GetOtherHours.Text,1,0):alert(r.GetOtherHours.Text);n.SetAttribute(t,"Title","HtmlPrefix","",1)},error:function(i){alert("Error: "+i);n.SetAttribute(t,"Title","HtmlPrefix","",1)}})}function StopEditGridRow(n,t){var t,r,u,i,f,e;if(t.id!=n.EditRow)if(t=n.GetRowById(n.EditRow),n.EditRow=null,n.EndEdit(!0),TimesheetItemEdited){n.SetAttribute(t,"Title","HtmlPrefix","<img src='/_layouts/15/epmlive/images/mywork/loading16.gif'>",1);r="";u="";for(i in n.Cols)n.Cols[i].Sec==0&&(n.GetAttribute(t,i,"CanEdit")=="1"&&i!="G"&&i!="Timesheet"&&(r+='<Field Name="'+i+'">'+n.GetValue(t,i)+"<\/Field>"),u+=","+i);f='<Row id="'+t.id+'" siteid="'+t.SiteID+'" webid="'+t.WebID+'" listid="'+t.ListID+'" itemid="'+t.ItemID+'" Cols="'+u+'">'+r+"<\/Row>";e=window.epmLiveNavigation.currentWebUrl;$.ajax({type:"POST",url:(e+"/_vti_bin/WorkEngine.asmx/ExecuteJSON").replace(/\/\//g,"/"),data:"{ Function: 'webparts_SetGridRowEdit', Dataxml: '"+f+"' }",contentType:"application/json; charset=utf-8",dataType:"json",success:function(i){var r=eval("("+i.d+")");r.Result.Status=="0"?n.AddDataFromServer(r.Result.InnerText):alert(r.Result.Error.Text);n.SetAttribute(t,"Title","HtmlPrefix","",1);StopEditCols(n,t)},error:function(i){alert("Error: "+i);n.SetAttribute(t,"Title","HtmlPrefix","",1)}})}else StopEditCols(n,t)}function TSOnFocus(n,t,i){curRow||(curRow=t);DoPopUp(n,t,i);t.ItemID&&(n.ActionClearSelection(),n.SelectRow(t));RefreshCommandUI()}function TSAOnFocus(n,t,i){curRow||(curRow=t);DoPopUp(n,t,i)}function TSOnMouseOverOutside(n){n.CurHoverRow&&n.SetAttribute(n.GetRowById(n.CurHoverRow),"Title","ButtonText"," ",1);n.CurHoverRow="0"}function TSOnMouseOverRow(n,t){n.CurHoverRow!=t.id&&(n.CurHoverRow=t.id,CurrentGrid=n,n.GetValue(t,"ItemID")!=""&&n.Rows[t.id].IsDeleted!="True"&&(n.SetAttribute(t,"Title","ButtonText",'<div class="gridmenuspan" style="position:absolute;overflow:visible" id="'+t.id+'"><a data-itemid="'+n.GetValue(t,"ItemID")+'" data-listid="'+n.GetValue(t,"ListID")+'" data-webid="'+n.GetValue(t,"WebID")+'" data-siteid="'+n.GetValue(t,"SiteID")+'" ><\/a><\/div>',1),window.epmLiveNavigation.addContextualMenu($("#"+t.id),[],!1,!0,{"delete":"GridGanttDeleteRow"})))}function TSOnMouseOutRow(n,t){n.SetAttribute(t,"Title","ButtonText"," ",1)}function TSDoubleClick(n,t,i){var r=n.id.substr(2),u=eval("TSObject"+r);u.Status=="Unsubmitted"&&n.Rows[t.id].IsDeleted!="True"&&EditGridRow(n,t,i)}function EditGridRow(n,t){var r,i,u,f;if(t.id!="Header"&&t.ItemID){r=window.epmLiveNavigation.currentWebUrl;i="";for(u in n.Cols)i+=","+u;i=i.substr(1);f='<Row id="'+t.id+'" siteid="'+t.SiteID+'" webid="'+t.WebID+'" listid="'+t.ListID+'" itemid="'+t.ItemID+'" Cols="'+i+'"/>';n.SetAttribute(t,"Title","HtmlPrefix","<img src='/_layouts/15/epmlive/images/mywork/loading16.gif'>",1);$.ajax({type:"POST",url:(r+"/_vti_bin/WorkEngine.asmx/ExecuteJSON").replace(/\/\//g,"/"),data:"{ Function: 'webparts_GetGridRowEdit', Dataxml: '"+f+"' }",contentType:"application/json; charset=utf-8",dataType:"json",success:function(i){var r=eval("("+i.d+")");r.Result.Status=="0"?(n.EditRow=t.id,n.AddDataFromServer(r.Result.InnerText),n.SetAttribute(t,"Title","HtmlPrefix",'<span class="icon-pencil" style="color: #CCC;padding-right:5px"><\/span>',1),n.StartEdit()):alert(r.Result.Error.Text)},error:function(n){alert("Error: "+n)}})}}function TSRenderFinish(n){var f=GetTSGridId(n),r,t,i,u;if(EPM.UI.Loader.current().stopLoading("WebPart"+eval("TSObject"+f+".Qualifier")),document.getElementById("tsnav").style.display="inline-block",curGrid=n,GridType=="0"){if(n.id.substr(0,2)=="TS"){clickTab();RefreshStopWatch();CheckSaveStatus(n.id);StartCheckApproveStatus(n.id);$(".TS_Comments").click(function(){showComments(n.id)});try{$("#tssw").tooltip()}catch(e){}ShowApprovalNotification();window.onbeforeunload=leavePage}if(!rendered){rendered=!0;r=n.id.substr(2);t=eval("TSObject"+r);for(i in t.Views)u=t.Views[i],u.Default=="true"&&setTimeout("SetLoadView('"+n.id+"','"+i+"')",100)}}else{eval("loadMenu"+n.id.substr(2)+"()");try{$("#tsan").tooltip()}catch(e){}}SetGridSize()}function SetLoadView(n,t){var i=Grids[n];ChangeView(i,t,"0")}function esGrid(){curPop&&(curGrid.EndEdit(!1),curGrid.StartEdit())}function showribbon(){var n=document.getElementById("Ribbon.MyTimesheetTab-title");n&&fireEvent(n.firstChild,"click")}function responseIsSuccess(n){return n.Result["@Status"]==0}function parseJson(n){return eval("("+xml2json(parseXml(n),"")+")")}function parseXml(n){var t=null;if(window.DOMParser)try{t=(new DOMParser).parseFromString(n,"text/xml")}catch(i){t=null}else if(window.ActiveXObject)try{t=new ActiveXObject("Microsoft.XMLDOM");t.async=!1;t.loadXML(n)}catch(i){t=null}return t}function CheckSaveStatus(n){var t=Grids[n];EPMLiveCore.WorkEngineAPI.ExecuteJSON("timesheet_CheckSaveStatus",'<Timesheet ID="'+t.TimesheetUID+'" />',function(i){var r=eval("("+i+")"),u,f,e;if(r.SaveStatus.Result=="0"){if(u="",r.SaveStatus.Status=="-1")return;r.SaveStatus.Status=="0"?u="Queued":r.SaveStatus.Status=="2"?u="Processing ("+r.SaveStatus.PercentComplete+"%)":r.SaveStatus.Status=="3"&&(u="Completed");r.SaveStatus.Status=="3"?(r.SaveStatus.ErrorResult=="No Errors"?TSStatusMessage!=null&&(SP.UI.Status.removeStatus(TSStatusMessage),TSStatusMessage=null):(SP.UI.Status.setStatusPriColor(TSStatusMessage,"red"),SP.UI.Status.updateStatus(TSStatusMessage,"Error: "+r.SaveStatus.ResultText)),bTSSaving&&(bTSSaving=!1,RefreshCommandUI()),bSaveAndSubmit&&(bSaveAndSubmit=!1,StartCheckApproveStatus(n),f=t.id.substr(2),e=eval("TSObject"+f),e.Status="Submitted",document.getElementById("mytimesheetstatus").innerHTML="Submitted",RefreshCommandUI())):(bTSSaving||(bTSSaving=!0,RefreshCommandUI()),TSStatusMessage==null?(TSStatusMessage=SP.UI.Status.addStatus("Save Status:",u,!0),SP.UI.Status.setStatusPriColor(TSStatusMessage,"blue")):(SP.UI.Status.updateStatus(TSStatusMessage,u),SP.UI.Status.setStatusPriColor(TSStatusMessage,"blue")),setTimeout("CheckSaveStatus('"+n+"')",2e3))}})}function UnSubmitTimesheet(n){ShowMessage(n,"Unsubmitting...",150,30);var t=Grids[n];EPMLiveCore.WorkEngineAPI.ExecuteJSON("timesheet_UnSubmitTimesheet",'<Timesheet ID="'+t.TimesheetUID+'" />',function(i){var r=eval("("+i+")"),u,f;HideMessage(t.id);r.UnSubmitTimesheet.Status=="0"?(u=t.id.substr(2),f=eval("TSObject"+u),f.Status="Unsubmitted",document.getElementById("mytimesheetstatus").innerHTML="Unsubmitted",EnableAllRows(t),HideMessage(n),AfterUnSubmit(t),RefreshCommandUI()):alert(r.UnSubmitTimesheet.Text)})}function SubmitTimesheet(n){if(StopWatchRow)alert("You have a stopwatch currently running, please stop the stopwatch before you submit");else{var t=Grids[n];TimesheetHoursEdited?(ShowMessage(n,"Saving and Submitting...",180,30),t.SaveAndSubmit="true",bSaveAndSubmit=!0,DisableAllRows(t),t.Save(),TimesheetHoursEdited=!1,HideMessage(t.id),AfterSubmit(t),RefreshCommandUI()):(ShowMessage(n,"Submitting...",140,30),EPMLiveCore.WorkEngineAPI.ExecuteJSON("timesheet_SubmitTimesheet",'<Timesheet ID="'+t.TimesheetUID+'" />',function(i){var r=eval("("+i+")"),u,f;HideMessage(t.id);r.SubmitTimesheet.Status=="0"?(u=t.id.substr(2),f=eval("TSObject"+u),f.Status="Submitted",document.getElementById("mytimesheetstatus").innerHTML="Submitted",DisableAllRows(t),AfterSubmit(t),RefreshCommandUI()):alert(decodeHtml(r.SubmitTimesheet.Text));StartCheckApproveStatus(n)}))}}function decodeHtml(n){var t=document.createElement("textarea");return t.innerHTML=n,t.value}function DisableAllRows(n){var i,t;for(i in n.Rows)t=n.Rows[i],t.Kind=="Data"&&t.id!="-1"&&n.SetAttribute(t,null,"CanEdit",0,!0,!1)}function EnableAllRows(n){var i,t;for(i in n.Rows)t=n.Rows[i],t.Kind=="Data"&&t.id!="-1"&&n.GetValue(t,"TSEnabled")=="1"&&n.SetAttribute(t,null,"CanEdit","1",!0,!1)}function ShowMessage(n,t,i,r){n=n.substr(2);HideMessage(n);spnMsg||(spnMsg=document.getElementById("spnMessage"+n));spnMsg.innerHTML=t;sm("divMessage"+n,i,r)}function HideMessage(n){hm("divMessage"+n)}function StartCheckApproveStatus(n){iApproveInterval&&clearInterval(iApproveInterval);CheckApproveStatus(n);iApproveInterval=setInterval("CheckApproveStatus('"+n+"')",1e4)}function ChangeView(n,t,i){var d=n.id.substr(2),c=eval("TSObject"+d),r=c.Views[t],l,e,o,u,s,a,b,k,h;r.Group==""?n.DoGrouping(null):n.DoGrouping(r.Group);var v=r.Cols.split(","),f={};for(l in v)l!="indexOf"&&(e=v[l].split("|"),f[e[0]]={},f[e[0]].Width=e.length>1?e[1]:"");var y=n.GetCols(""),p="",w="";for(o=0;o<y.length;o++)u=n.Cols[y[o]],u&&u.Sec==0&&(f[u.Name]?p+=","+u.Name:w+=","+u.Name);n.ChangeColsVisibility(p.substr(1).split(","),w.substr(1).split(","),0);for(s in f)if(a=f[s],a.Width!=""){b=n.GetAttribute(null,s,"Width");k=parseInt(a.Width)-b;try{n.SetWidth(s,k)}catch(g){}}r.Filters==""||r.Filters=="||"?n.ChangeFilter("","","",0,0,null):(h=r.Filters.split("|"),n.ChangeFilter(h[0],h[1],h[2],0,0,null));n.Sort=r.Sort;n.SortRows();(i=="1"||i==undefined)&&(c.CurrentViewId=t,c.CurrentView=unescape(r.Name),RefreshCommandUI(),n.Render())}function DeleteView(n,t){var i=0,r;ShowMessage(n.id,"Deleting View...",150,50);r='<View Name="'+escape(t)+'"/>';EPMLiveCore.WorkEngineAPI.ExecuteJSON("timesheet_DeleteView",r,function(t){var f=eval("("+t+")"),e,r,u,o;if(n.StaticCursor=1,HideMessage(n.id),f.Views.Status=="0"){e=n.id.substr(2);r=eval("TSObject"+e);r.Views=eval("("+f.Views.Text.replace(/&quot;/g,'"')+")");for(u in r.Views)o=r.Views[u],i++;(r.Views[u]!=""||r.Views[u]!=undefined||r.Views[u]!=null)&&(i!=0?ChangeView(n,u,"1"):(r.CurrentView="",r.CurrentViewId=""));RefreshCommandUI()}else alert(f.Views.Text)})}function checkDefaultView(n,t){var f=n.id.substr(2),r=eval("TSObject"+f),u,i;for(u in r.Views)if(i=r.Views[u],unescape(i.Name)==unescape(t))return i.Default}function RenameView(n,t,i){ShowMessage(n.id,"Renaming View...",150,50);var r='<View Name="'+escape(t)+'" NewName="'+escape(i[0])+'" Default="'+i[1]+'"/>';EPMLiveCore.WorkEngineAPI.ExecuteJSON("timesheet_RenameView",r,function(t){var u=eval("("+t+")"),e,r,f,o;if(n.StaticCursor=1,HideMessage(n.id),u.Views.Status=="0"){e=n.id.substr(2);r=eval("TSObject"+e);r.Views=eval("("+u.Views.Text.replace(/&quot;/g,'"')+")");for(f in r.Views)if(o=r.Views[f],unescape(o.Name)===unescape(i[0])){r.CurrentView=unescape(i[0]);r.CurrentViewId=f;break}RefreshCommandUI()}else alert(u.Views.Text)})}function SaveView(n,t){var o,s,i,e,a;ShowMessage(n.id,"Saving View...",150,50);n.StaticCursor=0;var l=n.GetRowById("Filter"),r="",u="",f="";for(o in n.Cols)s=l[o+"Filter"],s!=null&&s!=0&&(f+=","+s,u+=","+l[o],r+=","+o);f.length>0&&(f=f.substr(1));u.length>0&&(u=u.substr(1));r.length>0&&(r=r.substr(1));var v=r+"|"+u+"|"+f,h=n.GetCols("Visible"),c="";for(i=0;i<h.length;i++)e=n.Cols[h[i]],e&&e.Sec==0&&(c+=e.Name!="Title"?","+h[i]+"|"+e.Width:","+h[i]+"|");c=c.substr(1);a='<View Name="'+escape(t[0])+'" Default="'+t[1]+'" Filters="'+v+'" Group="'+n.Group+'" Sort="'+n.Sort+'" Cols="'+c+'" Expand="" />';EPMLiveCore.WorkEngineAPI.ExecuteJSON("timesheet_SaveView",a,function(i){var u=eval("("+i+")"),e,r,f,o;if(n.StaticCursor=1,HideMessage(n.id),u.Views.Status=="0"){e=n.id.substr(2);r=eval("TSObject"+e);r.Views=eval("("+u.Views.Text.replace(/&quot;/g,'"')+")");for(f in r.Views)if(o=r.Views[f],unescape(o.Name)==unescape(t[0])){r.CurrentView=unescape(t[0]);r.CurrentViewId=f;break}RefreshCommandUI()}else alert(u.Views.Text)})}function CheckApproveStatus(){return;var n}function OpenPMApprovals(n){var r=Grids["TS"+n],t,i;curGrid=r;t=siteColUrl+"/Lists/My%20Timesheet/Project%20Manager%20Approval.aspx";i={url:t,showMaximized:!0,title:"Approvals",autoSize:!1};SP.UI.ModalDialog.showModalDialog(i)}function AutoAddWork(n){var t,r,i,u,f;ShowMessage(n.id,"Adding Work...",130,30);t="";for(r in n.Rows)i=n.Rows[r],i.Kind=="Data"&&i.Def.Name=="R"&&(t+=","+i.ListID+"."+i.ItemID);t.length>0&&(t=t.substr(1));u=n.id.substr(2);f=eval("TSObject"+u);EPMLiveCore.WorkEngineAPI.ExecuteJSON("timesheet_AutoAddWork",'<Timesheet ID="'+n.TimesheetUID+'" Rows="'+t+'"  UserId="'+f.UserId+'"/>',function(t){var i=eval("("+t+")");i.AutoAddWork.Status=="0"?(HideMessage(n.id),CheckForUpdate(n)):(HideMessage(n.id),alert(i.AutoAddWork.Text))})}function ShowNotes(n,t,i,r,u){var f,o,e,s,h;NotesOut=!0;f=Grids[n];o=f.GetRowById(t);curGrid=f;curRow=o;curCol=i;e=document.getElementById("NotesDiv");e.style.display="";s=document.getElementById("txtNotes");s.value=f.GetValue(o,"TS"+i);s.focus();$("#NotesDiv").appendTo($("body"));h=$("#notesimg");e.style.top=h.offset().top+"px";e.style.left=h.offsetParent().offsetParent().offset().left+"px";stopProp(u)}function DoPopUp(n,t,i){var c,v,r,f,e,o,y,s;if(curRow!=t||curCol!=i||!curPop&&TSColType==2){curPop=!1;curRow&&curRow.Kind=="Data"&&curRow.id!="-1"&&curCol&&TSCols[curCol]&&n.SetAttribute(curRow,curCol,"HtmlPrefix","",!0,!1);curRow=t;curCol=i;curGrid=n;var w=n.id.substr(2),a=eval("TSObject"+w),u=!1;if(a.Locked&&(u=!0),a.Status!="Unsubmitted"&&(u=!0),n.GetValue(t,"TSEnabled")!="1"&&(u=!0),n.GetAttribute(t,"CanEdit")=="0"&&(u=!0),t&&t.Kind=="Data"&&t.id!="-1"&&i&&TSCols[i]&&t.Def.Name=="R")if(TSColType==1)TSNotes?(f=n.GetValue(t,"TS"+i),c="tsnonotes",f!=""&&(c="tsnotes"),n.EndEdit(!0),n.Focus(t,i),n.StartEdit(),v="<div style='position: absolute; margin-left: 65px; cursor:pointer; z-index: 999;' onMouseDown=\"stopProp(event);\" onClick=\"ShowNotes('"+n.id+"','"+t.id+"','"+i+'\',this,event);"><img id="notesimg" class="transparentnotes" src="/_layouts/epmlive/images/'+c+'.png"><\/div>',n.SetAttribute(t,i,"HtmlPrefix",v,!0,!1)):setTimeout("curGrid.StartEdit()",100);else if(TSColType==2){try{$("#TypeDivOuter").remove()}catch(b){}curPop=!0;r='<div id=\'TypeDivOuter\' style=\'position: absolute; margin-top: 20px; margin-left: 2px;z-index:999; cursor:default; width:156px; background-color: #F8F8F8; text-align:left;border: 1px solid #AAA; border-radius: 5px; padding:3px;\' onClick="stopProp(event);"><table border="0" cellspacing="3" cellpadding="0">';f=n.GetValue(t,"TS"+i);f==""&&(f="{}");e=eval("("+f+")");for(o in TSTypeObject){y=TSTypeObject[o];r+="<tr><td>"+y+':<\/td><td align="right"><input type="text" class="epmliveinput" onkeydown="stopProp(event);" onkeyup="stopProp(event);" onkeypress="stopProp(event);return isNumberKey(event);" onClick="this.select();stopProp(event);" style="width:25px" id="'+o+'TypeValue" Value="';try{r+=e[o]?e[o]:"0"}catch(b){}r+='"';u&&(r+=' disabled="disabled"');r+="><\/td><\/tr>"}TSNotes&&(s="",e.Notes&&(s=e.Notes,s=unescape(s).replace(/<br>/g,"\r\n")),r+='<tr><td colspan="2"><textarea class="epmliveinput" id=\'txtTNotes\' style=\'width:140px;height:75px;outline:0;resize:none\' ondblclick="stopProp(event);" onkeydown="stopProp(event);" onkeyup="stopProp(event);" onclick="stopProp(event);" onkeypress="stopProp(event);"',u&&(r+=' disabled="disabled"'),r+=">"+s+"<\/textarea><\/td><\/tr>");r+='<tr><td colspan="2" align="right">';u||(r+='<input type="button" value="OK" class="tsOK" onClick="SaveTypes(event);">&nbsp;');r+='<input type="button" value="Cancel" class="tsOK" onClick="CloseTypes(event);"><\/td><\/tr><\/table><\/div><div style=\'position: absolute; margin-top: -10px; margin-left: -9px \'><img src=\'/_layouts/epmlive/images/tsoutline.png\'><\/div>';n.SetAttribute(t,i,"HtmlPrefix","<div id='typedivlocation'>",!0,!1);$("body").append(r);var l=$("#TypeDivOuter"),p=l.get(0),h=$("#typedivlocation");p.style.top=h.offset().top-28+l.height()>$(window).height()?h.offset().top-l.height()+"px":h.offset().top-28+"px";p.style.left=h.offset().left-5+"px";setTimeout("curGrid.StartEdit()",100)}}}function isNumberKey(n){var t=n.which?n.which:event.keyCode;return t!=46&&t!=44&&t>31&&(t<48||t>57)?!1:!0}function GetGridId(n){return n.id.substr(2)}function SetGridSize(){var n=document.getElementById("gridouter"),t=GetPageHeight(),i=GetItemTop(n);n.style.height=t-i-35+"px"}function CheckForUpdate(n){var t,u,r,i;curGrid=n;ShowMessage(n.id,"Refreshing Timesheet",180,50);t="";for(u in n.Rows)r=n.Rows[u],r.Kind=="Data"&&r.Def.Name=="R"&&(t+=","+r.UID);t.length>0&&(t=t.substr(1));i="&lt;Param";i+=' ID="'+n.TimesheetUID+'"';i+=' Rows="'+t+'"';i+="/&gt;";n.Data.Check.Param.Dataxml=i;n.CheckForUpdates(CheckedUpdates)}function CheckedUpdates(){var n=curGrid.id.substr(2),t=eval("TSObject"+n);ChangeView(curGrid,t.CurrentViewId,"1");HideMessage(curGrid.id)}function StopStopWatchClose(n){var i,f,e,t;if(n==SP.UI.DialogResult.OK)if(TSColType==1)for(f in StopWatchResponse)f!="Status"&&(i=StopWatchResponse[f],t=parseFloat(curStoppingGrid.GetValue(curStoppingRow,"P"+i.DateTicks)),isNaN(t)&&(t=0),t+=parseFloat(i.Minutes)/60,curStoppingGrid.SetValue(curStoppingRow,"P"+i.DateTicks,parseFloat(t.toFixed(2)),1,0));else if(TSColType==2)for(f in StopWatchResponse)if(f!="Status"){var i=StopWatchResponse[f],o=curStoppingGrid.GetValue(curStoppingRow,"TSP"+i.DateTicks),u=null;o!=""&&(u=eval("("+o+")"));var s=0,h=!1,r="";for(e in TSTypeObject)t=0,u&&u[e]&&(t=u[e]),h||(t+=parseFloat(i.Minutes)/60,h=!0),t!="NaN"&&t!=0&&(r+=","+e+": "+t.toFixed(2),s+=t);TSNotes&&u&&u.Notes&&(r+=',Notes: "'+u.Notes+'"');r.length>0&&(r=r.substr(1));r="{"+r+"}";curStoppingGrid.SetValue(curStoppingRow,"P"+i.DateTicks,parseFloat(s.toFixed(2)),1,0);curStoppingGrid.SetValue(curStoppingRow,"TSP"+i.DateTicks,r,0,0)}bStopWatchStartWaiting&&(bStopWatchStartWaiting=!1,StartStopWatch(curGrid,curRow))}function StopStopWatch(n,t){var i=n.id.substr(2),r=eval("TSObject"+i);EPMLiveCore.WorkEngineAPI.ExecuteJSON("timesheet_StopStopWatch",'<StopWatch ID="'+t.UID+'" UserId="'+r.UserId+'"/>',function(i){var u=eval("("+i+")"),s,r,h,o,f,e,l;if(u.StopWatch.Status=="0"){s=!1;r=document.createElement("p");r.setAttribute("style","padding:10px");o=document.createTextNode("Would you like to apply the following to your timesheet: ");r.appendChild(o);r.appendChild(document.createElement("br"));r.appendChild(document.createElement("br"));StopWatchResponse=u.StopWatch;for(h in u.StopWatch)if(h!="Status"){var c=u.StopWatch[h],a=new Date(c.Date),v=c.Minutes,y=n.Cols["P"+c.DateTicks];y&&(s=!0,o=document.createTextNode(a.format("MMM dd")+": "+GetTimeDisplay(parseFloat(v)*6e4)),r.appendChild(o),r.appendChild(document.createElement("br")))}s?(curStoppingGrid=n,curStoppingRow=t,f=document.createElement("input"),f.setAttribute("type","button"),f.setAttribute("value","Yes"),f.setAttribute("onclick","SP.UI.ModalDialog.commonModalDialogClose(SP.UI.DialogResult.OK, 0);"),r.appendChild(document.createElement("br")),r.appendChild(document.createElement("br")),r.appendChild(f),e=document.createElement("input"),e.setAttribute("type","button"),e.setAttribute("value","No"),e.setAttribute("onclick","SP.UI.ModalDialog.commonModalDialogClose(SP.UI.DialogResult.Cancel, 0);"),r.appendChild(e),l={title:"Confirm Hours",width:300,html:r,dialogReturnValueCallback:StopStopWatchClose},SP.UI.ModalDialog.showModalDialog(l)):alert("There were no dates to apply to this period");n.SetAttribute(t,"StopWatch","Icon","/_layouts/epmlive/images/tstimeroff.png",!0,!1);StopWatchRow=null;n.SetValue(t,"StopWatch","",1,0)}else alert(u.StopWatch.Text)})}function StartStopWatch(n,t){var u=n.id.substr(2),i=eval("TSObject"+u),r;IsLocked(n)?alert("You cannot start a stop watch on a submitted timesheet"):i.IsCurPeriod?EPMLiveCore.WorkEngineAPI.ExecuteJSON("timesheet_StartStopWatch",'<StopWatch ID="'+t.UID+'" UserId="'+i.UserId+'"/>',function(i){var r=eval("("+i+")");r.StopWatch.Status=="0"?(n.SetValue(t,"StopWatch",r.StopWatch.Text,1,0),n.SetAttribute(t,"StopWatch","Icon","/_layouts/epmlive/images/tstimeron.png",!0,!1),StopWatchRow=t,StopWatchGrid=n,RefreshStopWatch()):alert(r.StopWatch.Text)}):i.CurPeriodId==0?alert("You can only start stopwatches within the period that the current date resides and there seems to be no period setup for today's date."):confirm("You can only start stopwatches within the period that the current date resides. Would you like to switch to period: "+i.CurPeriodName+"?")&&(r=i.TSURL,r+=r.indexOf("?")>0?"&":"?",location.href=r+"NewPeriod="+i.CurPeriodId)}function ShowApprovalNotes(n,t,i){var r=Grids[n],u=r.GetRowById(t),f=$("#"+i.id),e;curPop=!0;e=f.offset().top-87;$("body").append("<div id='divanotes"+t.replace(/-/g,"")+"' style='width:150px;height:100px;position:absolute;left:"+f.offset().left+"px;top:"+e+'px;border:1px solid #DDD;background-color:#FFF\' onMouseDown="stopProp(event);" ><textarea id="anotestxt'+t.replace(/-/g,"")+'" style=\'width:140px;height:60px;border:none;resize: none;outline:none\' onkeyup="stopProp(event);" onclick="stopProp(event);" onkeypress="stopProp(event);">'+r.GetValue(u,"ApprovalNotes")+'<\/textarea><input type="button" style="float:right" value="Ok" onclick="CloseApprovalNotes(\''+r.id+"','"+u.id+"');\"><\/div>")}function CloseApprovalNotes(n,t){var i=Grids[n],r=i.GetRowById(t),u=$("#anotestxt"+t.replace(/-/g,""));i.SetValue(r,"ApprovalNotes",u.get(0).value,1);$("#divanotes"+t.replace(/-/g,"")).remove();curPop=!1}function MYTSOnGetHtmlValue(n,t,i,r){var f,u,o;if(n.id.substr(0,2)=="TS")if(t.Def.Name=="Resource"){if(i=="ApprovalNotes")return f="DDD",n.GetValue(t,i)!=""&&(f="888"),t.Approved=="1"||t.Approved=="2"||t.Submitted=="1"?"<a onclick=\"ShowApprovalNotes('"+n.id+"','"+t.id+'\', this)" id="ANote'+t.id+"\" style=\"text-decoration:none;\"><span class='icon-file-3' style='color:#"+f+";text-decoration:none;font-size:15px'><\/a>":"";if(i=="TMApproval")return t.Approved=="1"?'<span class="icon-checkmark-circle-2" style="color:#5BB75B">':t.Approved=="2"?'<span class="icon-cancel-circle-2" style="color:#D9534F">':t.Submitted=="1"?'<span class="icon-redo" style="color:#888">':"";if((TSCols[i]||i=="TSTotals")&&(r=="0"||r==""))return""}else if(t.Def.Name=="R")if(i=="StopWatch"){if(StopWatchRow&&t.UID==StopWatchRow.UID){var s=new Date(r),h=new Date((new Date).getTime()-curServerDate),e=h.getTime()-s.getTime();return e<0?"0m":GetTimeDisplay(e)}}else{if(TSCols[i]||i=="TSTotals")return(u="",TSColType==1&&TSNotes&&(o=n.GetValue(t,"TS"+i),o!=""&&(u="*")),r=="0"||r=="")?u:getFormattedNumber(r.toLocaleString(),n)+u;if(i=="Progress"&&t.Def.Name=="R")try{return(parseFloat(r)*100).toFixed(0)+"%"}catch(c){return"0%"}else if(i=="Title")return n.GetValue(t,"HasComments")=="1"?r=r+"&nbsp;<a href=\"javascript:GridComments('"+n.id+"','"+t.id+'\');return false;"><img src="/_layouts/15/epmlive/images/mywork/comment-small.png" border="0"><\/a>':n.GetValue(t,"HasComments")=="2"&&(r=r+"&nbsp;<a href=\"javascript:GridComments('"+n.id+"','"+t.id+'\');return false;"><img src="/_layouts/15/epmlive/images/mywork/commentsnew-small.png" border="0"><\/a>'),r}else if(t.id=="Header")return i=="Panel"?null:r;return r=="",null}function GridComments(n,t){var u=Grids[n],r=u.GetRowById(t),f,i;CurrentGrid=u;CurrentRow=r;n=GetGridId(u);f=window.epmLiveNavigation.currentWebUrl+"/_layouts/epmlive/gridaction.aspx?action=comments&webid="+r.WebID+"&listid="+r.ListID+"&ID="+r.ItemID+"&Source="+escape(location.href);i=window.SP.UI.$create_DialogOptions();i.url=f;i.width=600;i.allowMaximize=!1;i.showClose=!0;window.SP.UI.ModalDialog.showModalDialog(i)}function getFormattedNumber(n,t){var f=t.id.substr(2),e=eval("TSObject"+f),o=Number("1.2").toLocaleString().substr(1,1),s=n.toLocaleString(),r=String(s).split(o),u=r[0],i=r.length>1?r[1]:"";return(i=(i+"00").substr(0,2),parseInt(i)==0)?u:u+e.DecimalSeparator+i}function GetTimeDisplay(n){var r=6e4,u=r*60,e=u*24,f=Math.floor(n/e),t,i,o;return n=n-f*e,t=Math.floor(n/u),n=n-t*u,i=Math.floor(n/r),n=n-i*r,o=Math.floor(n/1e3),f>0?f+"d "+t+"h "+i+"m":t>0?t+"h "+i+"m":i+"m"}function RefreshStopWatch(){StopWatchRow&&StopWatchGrid&&(StopWatchGrid.RefreshCell(StopWatchRow,"StopWatch"),setTimeout("RefreshStopWatch()",3e4))}function GetDecimalFromTime(n){var i=n.split(":"),r=StringToNumber(i[0]),t;return i.length>1&&(t=StringToNumber(i[1]),t=t/60,r+=t),parseFloat(r.toFixed(2))}function CloseTypes(n){curGrid.EndEdit(!1);curGrid.SetAttribute(curRow,curCol,"HtmlPrefix","",!0,!1);curPop=!1;$("#TypeDivOuter").remove();stopProp(n)}function SaveTypes(n){var e,o,r;curGrid.EndEdit(!1);var t="",u=0,i=0,f=0;for(e in TSTypeObject)if(o=document.getElementById(e+"TypeValue").value,o!=""){if(r=GetDecimalFromTime(o),r==null||r.toString()=="NaN"){alert("This is not a valid entry");return}r!=0&&(t+=","+e+": "+r,i+=r)}if(u=curGrid.GetValue(curRow,curCol),f=curGrid.GetValue(curGrid.Rows[-1],curCol),TSDCols[curCol]){var c=TSDCols[curCol].split("|"),s=parseFloat(c[0]),h=parseFloat(c[1]);i>h||f-u+i>h?alert("You may only enter a maximum time of "+h+" hours"):i<s||f-u+i<s?alert("You must enter atleast time of "+s+" hours"):(TSNotes&&(t+=',Notes: "'+escape(document.getElementById("txtTNotes").value.replace(/\r\n/g,"<br>"))+'"'),t.length>0&&(t=t.substr(1)),t="{"+t+"}",curGrid.SetAttribute(curRow,curCol,"HtmlPrefix","",!0,!1),curGrid.SetValue(curRow,curCol,i,1,0),curGrid.GetValue(curRow,"TS"+curCol)!=t&&(TimesheetHoursEdited=!0),curGrid.SetValue(curRow,"TS"+curCol,t,0,0))}curPop=!1;$("#TypeDivOuter").remove();stopProp(n)}function SaveNotes(n){var t,i;NotesOut=!1;t=document.getElementById("txtNotes").value;TSColType==1&&curGrid.SetValue(curRow,"TS"+curCol,t);document.getElementById("NotesDiv").style.display="none";i=document.getElementById("notesimg");i.src=t==""?"/_layouts/epmlive/images/tsnonotes.png":"/_layouts/epmlive/images/tsnotes.png";stopProp(n)}function stopProp(n){n.stopPropagation?n.stopPropagation():window.event&&(window.event.cancelBubble=!0)}function BeforeSave(n){if(typeof TimesheetBeforeSave=="function"){try{var t=TimesheetBeforeSave(n);return t.CanSave?!0:(alert(t.Message),!1)}catch(i){alert("Error Checking Save: "+i)}return!1}return!0}function AfterSave(n){if(typeof TimesheetAfterSave=="function")try{TimesheetAfterSave(n)}catch(t){alert("Error After Save: "+t)}}function BeforeSubmit(n){if(typeof TimesheetBeforeSubmit=="function"){try{var t=TimesheetBeforeSubmit(n);return t.CanSubmit?!0:(alert(t.Message),!1)}catch(i){alert("Error Checking Submit: "+i)}return!1}return!0}function IsLocked(n){var i=n.id.substr(2),t=eval("TSObject"+i);return t.Locked||bTSApproving?!0:t.Status!="Unsubmitted"?!0:!1}function AfterSubmit(n){if(typeof TimesheetAfterSubmit=="function")try{TimesheetAfterSubmit(n)}catch(t){alert("Error After Submit: "+t)}}function BeforeUnSubmit(n){if(typeof TimesheetBeforeUnSubmit=="function"){try{var t=TimesheetBeforeUnSubmit(n);return t.CanUnSubmit?!0:(alert(t.Message),!1)}catch(i){alert("Error Checking UnSubmit: "+i)}return!1}return!0}function AfterUnSubmit(n){if(typeof TimesheetAfterUnSubmit=="function")try{TimesheetAfterUnSubmit(n)}catch(t){alert("Error After UnSubmit: "+t)}}function fireEvent(n,t){var i;return document.createEventObject?(i=document.createEventObject(),n.fireEvent("on"+t,i)):(i=document.createEvent("HTMLEvents"),i.initEvent(t,!0,!0),!n.dispatchEvent(i))}function leavePage(){var n="";return TimesheetHoursEdited&&(n="You have unsaved changes."),n!=""?n:void 0}function ShowApprovalNotification(){EPMLiveCore.WorkEngineAPI.set_path(siteUrl+"/_vti_bin/WorkEngine.asmx");EPMLiveCore.WorkEngineAPI.ExecuteJSON("timesheet_ShowApprovalNotification","<ApprovalNotification PeriodId='"+periodId+"' />",function(n){var t=eval("("+n+")");t.ApprovalNotification.Status=="0"&&t.ApprovalNotification.Text!="0"?updateStatusBox?SP.UI.Status.updateStatus(updateStatusBox,"You have "+t.ApprovalNotification.Text+" timesheet(s) pending for approval <a href='#' onclick='Javascript:DoTmAprrovals();'>[Timesheet Manager]<\/a>"):(updateStatusBox=SP.UI.Status.addStatus("Notification:","You have "+t.ApprovalNotification.Text+" timesheet(s) pending for approval <a href='#' onclick='Javascript:DoTmAprrovals();'>[Timesheet Manager]<\/a>",!0),SP.UI.Status.setStatusPriColor(updateStatusBox,"blue")):t.ApprovalNotification.Text!="0"&&SP.UI.Status.removeStatus(updateStatusBox);t.ApprovalNotification.IsTimeSheetManager=="True"&&(bIsTimeSheetManager=!0,RefreshCommandUI());t.ApprovalNotification.IsProjectManager=="True"&&(bIsProjectManager=!0,RefreshCommandUI())})}function DoTmAprrovals(){var n=siteColUrl+"/_layouts/15/epmlive/mytimesheet.aspx?Approvals=true";location.href=n}function showComments(n){var i=Grids[n],t=i.ARow,r=siteUrl+"/_layouts/epmlive/gridaction.aspx?action=comments&webid="+t.WebID+"&listid="+t.ListID+"&ID="+t.ItemID,u={title:"Comments",allowMaximize:!0,showClose:!0,url:r};SP.UI.ModalDialog.showModalDialog(u)}function previousPeriodCommand(n,t,i){if(t!="0"){var r=n;r+=r.indexOf("?")>0?"&NewPeriod="+t:"?NewPeriod="+t;i!=""&&(r+="&Delegate="+i);location.href=r}}function nextPeriodCommand(n,t,i){if(t!="0"){var r=n;r+=r.indexOf("?")>0?"&NewPeriod="+t:"?NewPeriod="+t;i!=""&&(r+="&Delegate="+i);location.href=r}}function changePeriodCommand(n,t,i){var r=n,u=t.options[t.selectedIndex].value;r+=r.indexOf("?")>0?"&NewPeriod="+u:"?NewPeriod="+u;i!=""&&(r+="&Delegate="+i);location.href=r}function GetPageHeight(){var n;return self.innerHeight?n=self.innerHeight:document.documentElement&&document.documentElement.clientHeight?n=document.documentElement.clientHeight:document.body&&(n=document.body.clientHeight),n}function GetItemTop(n){for(var t=n.offsetTop;n.offsetParent;)if(t=t+n.offsetParent.offsetTop,n==document.getElementsByTagName("body")[0])break;else n=n.offsetParent;return t}var curRow,curCol,TSColType,TSNotes,TSTypeObject,TSCols,curGrid,curPop=!1,StopWatchRow=null,StopWatchGrid=null,siteId,siteUrl,siteColUrl,periodId,sApplyDates="",curStoppingRow,curStoppingGrid,StopWatchResponse,bStopWatchStartWaiting=!1,cView,TSStatusMessage=null,TSApprovalMessage=null,bTSSaving=!1,bTSApproving=!1,iApproveInterval,curServerDate,spnMsg=null,bSaveAndSubmit=!1,updateStatusBox,NotesOut=!1,LoadGenericMenu=!0,TimesheetHoursEdited=!1,TimesheetItemEdited=!1,rendered=!1,bIsTimeSheetManager=!1,bIsProjectManager=!1,DataXML=null;Grids.OnRenderStart=function(n){var r,i,u,t;if(n.id.substr(0,2)=="TS"){r=n.id.substr(2);i=eval("TSObject"+r);i&&(n.TSObject=i);for(u in n.Rows)t=n.Rows[u],t.Kind=="Data"&&n.GetValue(t,"StopWatch")!=""&&(StopWatchRow=t,StopWatchGrid=n);DataXML==null&&(DataXML=n.Source.Data.Param.Dataxml);EPMLiveCore.WorkEngineAPI.set_path(siteUrl+"/_vti_bin/WorkEngine.asmx")}};Grids.OnStartEdit=function(){if(NotesOut){NotesOut=!1;var n=document.getElementById("NotesDiv");n.style.display="none"}};Grids.OnScroll=function(n){curRow&&curRow.Kind=="Data"&&curRow.id!="-1"&&curCol&&TSCols[curCol]&&(n.SetAttribute(curRow,curCol,"HtmlPrefix","",!0,!1),curPop=!1)};Grids.OnKeyDown=function(n,t){if(curPop||t==46)return!0;curGrid=n;setTimeout("esGrid()",10)};Grids.OnEnterEdit=function(){curPop&&setTimeout("curGrid.StartEdit()",100)};Grids.OnKeyPress=function(){};Grids.OnAfterSave=function(n){n.id.substr(0,2)=="TS"&&((n.IO.Result=="0"||n.IO.Result=="2")&&(bTSSaving=!0,RefreshCommandUI(),CheckSaveStatus(n.id)),HideMessage(n.id))};Grids.OnClickOutside=function(n){if(NotesOut){NotesOut=!1;curPop=!1;var t=document.getElementById("NotesDiv");t.style.display="none"}try{$("#TypeDivOuter").remove()}catch(i){}n.EditRow&&StopEditGridRow(n,n.GetRowById("Header"))};$(window).resize(function(){SetGridSize()});Grids.OnIconClick=function(n,t,i,r){n.id.substr(0,2)=="TS"&&r<16&&i=="StopWatch"&&(StopWatchRow?StopWatchRow.UID==t.UID?confirm("Would you like to stop that stop watch now?")&&StopStopWatch(n,t):confirm("There is already a stop watch running. Would you like to stop that stopwatch and start this one?")?(curGrid=n,curRow=t,StopStopWatch(StopWatchGrid,StopWatchRow),bStopWatchStartWaiting=!0):bStopWatchStartWaiting:StartStopWatch(n,t))};Grids.OnValueChanged=function(n,t,i,r){if(n.id.substr(0,2)=="TS"&&t&&t.Kind=="Data"&&t.id!="-1"&&i&&TSCols[i]){r.toString()==""&&(r="0");var f=0,s=GetDecimalFromTime(r),u=n.GetValue(t,i);if(f=n.GetValue(n.Rows[-1],i),s.toString()=="NaN"?(alert("That is not a valid entry."),r=u):r=s,TSDCols[i]){var h=TSDCols[i].split("|"),e=parseFloat(h[0]),o=parseFloat(h[1]);(r>o||f-u+r>o)&&(alert("You may only enter a maximum time of "+o+" hours"),r=u);(r<e||f-u+r<e)&&(alert("You must enter atleast time of "+e+" hours"),r=u)}}return r};