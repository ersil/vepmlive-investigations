function Approve(n){ProcessApprovals(n,"1")}function Reject(n){ProcessApprovals(n,"2")}function Unlock(n){ProcessApprovals(n,"0")}function ProcessApprovals(n,t){var r=Grids["TS"+n],i=r.GetSelRows(),u,f;if(i.length<=0)alert("You must select 1 or more rows");else{u="";for(f in i)u+='<TS id="'+i[f].id+'">'+r.GetValue(i[f],"ApprovalNotes")+"<\/TS>";ShowMessage(r.id,"Processing Timesheets...",200,50),EPMLiveCore.WorkEngineAPI.Execute("timesheet_ApproveTimesheets",'<Approve ApproveStatus="'+t+'">'+u+"<\/Approve>",function(n){var u,f;if(n=parseJson(n),u="",t=="1"?u="Approved":t=="2"?u="Rejected":t=="0"&&(u="Submitted"),n.Result["@Status"]=="0")for(f in i)r.SetValue(i[f],"TMApproval",'<img src="/_layouts/15/epmlive/images/ts/'+u+'.png" alt="'+u+'">',1);else alert("Error: "+n.Result.Errors);HideMessage(r.id)})}}function GetTSGridId(n){return n.id.substr(2)}function LoadTSGrid(gridid){EPM.UI.Loader.current().startLoading({id:"WebPart"+eval("TSObject"+gridid+".Qualifier")})}function TSRenderFinish(grid){var gridid=GetTSGridId(grid);EPM.UI.Loader.current().stopLoading("WebPart"+eval("TSObject"+gridid+".Qualifier")),document.getElementById("tsnav").style.display="",curGrid=grid,GridType=="0"?grid.id.substr(0,2)=="TS"&&(clickTab(),RefreshStopWatch(),CheckSaveStatus(grid.id),StartCheckApproveStatus(grid.id),$(".TS_Comments").click(function(){showComments(grid.id)})):eval("loadMenu"+grid.id.substr(2)+"()")}function esGrid(){curPop&&(curGrid.EndEdit(!1),curGrid.StartEdit())}function showribbon(){var n=document.getElementById("Ribbon.MyTimesheetTab-title");n&&fireEvent(n.firstChild,"click")}function editSaveRow(n,t){var r=Grids[n],i=r.Rows[t];i.Def.Name!=="Header"&&i.Def.Name!=="Fixed"&&i.Def.Name!=="Group"&&i.Complete!=1&&($("#MTG_Processing_"+i.ItemID).show(),editRow(r,i))}function editRow(n,t){var i=t.ListID+t.WebID+siteId,r;n.RowPermissions===undefined&&(n.RowPermissions={}),n.RowPermissions[i]===undefined?(r='<MyWork><List ID="'+t.ListID+'" /><Web ID="'+t.WebID+'" /><Site ID="'+siteId+'" URL="'+siteUrl+'" /><\/MyWork>',EPMLiveCore.WorkEngineAPI.Execute("CheckMyWorkListEditPermission",r,function(r){r=parseJson(r),responseIsSuccess(r)&&(n.RowPermissions[i]=r.Result.MyWork.HasEditPermission==="true"?!0:!1,editRowHelper(n,t))})):editRowHelper(n,t)}function editRowHelper(n,t){var f=n.ColNames[0],r=t.ListID+t.WebID+siteId,i,u,e;if(n.RowPermissions[r])if(t.EditMode===undefined&&(t.EditMode=1),n.TotalRowsInEditMode===undefined&&(n.TotalRowsInEditMode=0),n.TotalRowsInEditMode++,t.isBeingEdited=!0,n.ColTypes==undefined&&(n.ColTypes={}),n.ColTypes[r]==undefined){n.ColTypes[r]={},i='<FieldInfo><Item ID="'+t.ItemID+'" /><List ID="'+t.ListID+'" /><Web ID="'+t.WebID+'" /><Site ID="'+siteId+'" URL="'+siteUrl+'" /><Fields>Priority,Title,';for(u in f)i+=f[u]+",";i=i.substring(0,i.length-1),i+="<\/Fields><GuessOriginalFieldName>True<\/GuessOriginalFieldName><\/FieldInfo>",EPMLiveCore.WorkEngineAPI.Execute("IsFieldEditable",i,function(u){var e,o,s;if(u=parseJson(u),responseIsSuccess(u)){e=u.Result.FieldInfo.Fields.Field,i='<MyWork><Item ID="'+t.ItemID+'" /><List ID="'+t.ListID+'" /><Web ID="'+t.WebID+'" /><Site ID="'+siteId+'" URL="'+siteUrl+'" /><Fields>';for(o in e)s=e[o]["@Name"],e[o]["@Editable"]=="true"&&(i+=s+",");i=i.substring(0,i.length-1),i+="<\/Fields><GuessOriginalFieldName>True<\/GuessOriginalFieldName><IsFromMyTimesheet>True<\/IsFromMyTimesheet><\/MyWork>",EPMLiveCore.WorkEngineAPI.Execute("GetMyWorkGridColType",i,function(i){var u,o,s;if(i=parseJson(i),responseIsSuccess(i)){for(e=i.Result.MyWork.Fields.Field,u=0;u<e.length;u++)o=e[u]["@Name"],s=e[u]["@Type"],n.ColTypes[r][o]=s,n.SetAttribute(t,o,"Type",s,!0,!1),s!=="Lines"&&n.SetAttribute(t,o,"CanEdit",1,!0,!1);editRowFinalizer(n,t,f,r)}})}})}else{for(u in n.ColTypes[r])e=n.ColTypes[r][u],n.SetAttribute(t,u,"Type",e,!0,!1),e!=="Lines"&&n.SetAttribute(t,u,"CanEdit",1,!0,!1);editRowFinalizer(n,t,f,r)}else $("#MTG_Processing_"+t.ItemID).hide(),SP.UI.Notify.addNotification("You do not have permission to edit this item.",!1)}function editRowFinalizer(n,t,i,r){var u={},o,s,e,f,h;u.Priority=t.Priority,u.DueDay=t.DueDay,u.Title=t.Title;for(f in i)o=i[f],s=t[o],u[o]=s!=undefined?s:"";t.currentValues=u,e="";for(f in n.ColTypes[r])h=n.ColTypes[r][f],h=="Enum"&&(e+=f+",");e!=""?(dataXml='<MyWork><Item ID="'+t.ItemID+'" /><List ID="'+t.ListID+'" /><Web ID="'+t.WebID+'" /><Site ID="'+siteId+'" URL="'+siteUrl+'" /><Fields>'+e,dataXml=dataXml.substring(0,dataXml.length-1),dataXml+="<\/Fields><GuessOriginalFieldName>True<\/GuessOriginalFieldName><\/MyWork>",EPMLiveCore.WorkEngineAPI.Execute("GetMyWorkGridEnum",dataXml,function(i){var r,u,f;if(i=parseJson(i),responseIsSuccess(i)){r=i.Result.MyWork.Fields.Field;for(u in r)f=r[u]["@Name"],n.SetAttribute(t,f,"Enum",r[u]["@Enum"],!0,!1),n.SetAttribute(t,f,"EnumKeys",r[u]["@EnumKeys"],!0,!1),n.SetAttribute(t,f,"Range",r[u]["@Range"],!0,!1);$("#MTG_Processing_"+t.ItemID).hide()}})):$("#MTG_Processing_"+t.ItemID).hide()}function parseJson(response){return eval("("+xml2json(parseXml(response),"")+")")}function parseXml(n){var t=null;if(window.DOMParser)try{t=(new DOMParser).parseFromString(n,"text/xml")}catch(i){t=null}else if(window.ActiveXObject)try{t=new ActiveXObject("Microsoft.XMLDOM"),t.async=!1,t.loadXML(n)}catch(i){t=null}return t}function responseIsSuccess(n){return n.Result["@Status"]==0}function CheckSaveStatus(n){var t=Grids[n];EPMLiveCore.WorkEngineAPI.ExecuteJSON("timesheet_CheckSaveStatus",'<Timesheet ID="'+t.TimesheetUID+'" />',function(response){var oResponse=eval("("+response+")"),status,newgridid,newobj;if(oResponse.SaveStatus.Result=="0"){if(status="",oResponse.SaveStatus.Status=="-1")return;oResponse.SaveStatus.Status=="0"?status="Queued":oResponse.SaveStatus.Status=="2"?status="Processing ("+oResponse.SaveStatus.PercentComplete+"%)":oResponse.SaveStatus.Status=="3"&&(status="Completed"),oResponse.SaveStatus.Status=="3"?(oResponse.SaveStatus.ErrorResult=="No Errors"?TSStatusMessage!=null&&(SP.UI.Status.removeStatus(TSStatusMessage),TSStatusMessage=null):(SP.UI.Status.setStatusPriColor(TSStatusMessage,"red"),SP.UI.Status.updateStatus(TSStatusMessage,"Error: "+oResponse.SaveStatus.ResultText)),bTSSaving&&(bTSSaving=!1,RefreshCommandUI()),bSaveAndSubmit&&(bSaveAndSubmit=!1,StartCheckApproveStatus(n),newgridid=t.id.substr(2),newobj=eval("TSObject"+newgridid),newobj.Status="Submitted",RefreshCommandUI())):(bTSSaving||(bTSSaving=!0,RefreshCommandUI()),TSStatusMessage==null?(TSStatusMessage=SP.UI.Status.addStatus("Save Status:",status,!0),SP.UI.Status.setStatusPriColor(TSStatusMessage,"blue")):(SP.UI.Status.updateStatus(TSStatusMessage,status),SP.UI.Status.setStatusPriColor(TSStatusMessage,"blue")),setTimeout("CheckSaveStatus('"+n+"')",2e3))}})}function UnSubmitTimesheet(n){ShowMessage(n,"Unsubmitting...",150,30);var t=Grids[n];EPMLiveCore.WorkEngineAPI.ExecuteJSON("timesheet_UnSubmitTimesheet",'<Timesheet ID="'+t.TimesheetUID+'" />',function(response){var oResponse=eval("("+response+")"),newgridid,newobj;HideMessage(t.id),oResponse.UnSubmitTimesheet.Status=="0"?(newgridid=t.id.substr(2),newobj=eval("TSObject"+newgridid),newobj.Status="Unsubmitted",EnableAllRows(t),HideMessage(n),AfterUnSubmit(t),RefreshCommandUI()):alert(oResponse.UnSubmitTimesheet.Text)})}function SubmitTimesheet(n){if(StopWatchRow)alert("You have a stopwatch currently running, please stop the stopwatch before you submit");else{var t=Grids[n];t.HasChanges()?(ShowMessage(n,"Saving and Submitting...",180,30),t.SaveAndSubmit="true",bSaveAndSubmit=!0,DisableAllRows(t),t.Save(),HideMessage(t.id),AfterSubmit(t),RefreshCommandUI()):(ShowMessage(n,"Submitting...",140,30),EPMLiveCore.WorkEngineAPI.ExecuteJSON("timesheet_SubmitTimesheet",'<Timesheet ID="'+t.TimesheetUID+'" />',function(response){var oResponse=eval("("+response+")"),newgridid,newobj;HideMessage(t.id),oResponse.SubmitTimesheet.Status=="0"?(newgridid=t.id.substr(2),newobj=eval("TSObject"+newgridid),newobj.Status="Submitted",DisableAllRows(t),AfterSubmit(t),RefreshCommandUI()):alert(oResponse.SubmitTimesheet.Text),StartCheckApproveStatus(n)}))}}function DisableAllRows(n){var i,t;for(i in n.Rows)t=n.Rows[i],t.Kind=="Data"&&t.id!="-1"&&n.SetAttribute(t,null,"CanEdit",0,!0,!1)}function EnableAllRows(n){var i,t;for(i in n.Rows)t=n.Rows[i],t.Kind=="Data"&&t.id!="-1"&&n.GetValue(t,"TSEnabled")=="1"&&n.SetAttribute(t,null,"CanEdit","1",!0,!1)}function ShowMessage(n,t,i,r){n=n.substr(2),HideMessage(n),spnMsg||(spnMsg=document.getElementById("spnMessage"+n)),spnMsg.innerHTML=t,sm("divMessage"+n,i,r)}function HideMessage(n){hm("divMessage"+n)}function StartCheckApproveStatus(n){iApproveInterval&&clearInterval(iApproveInterval),CheckApproveStatus(n),iApproveInterval=setInterval("CheckApproveStatus('"+n+"')",1e4)}function ChangeView(grid,view){var newgridid=grid.id.substr(2),newobj=eval("TSObject"+newgridid),oView=newobj.Views[view],oViewCol,oViewColInfo,i,vCol,oV,ooV,tWidth,dx,filters;oView.Group==""?grid.DoGrouping(null):grid.DoGrouping(oView.Group);var oViewCols=oView.Cols.split(","),sViewCols="",oVisible={};for(oViewCol in oViewCols)oViewCol!="indexOf"&&(oViewColInfo=oViewCols[oViewCol].split("|"),oVisible[oViewColInfo[0]]={},oVisible[oViewColInfo[0]].Width=oViewColInfo.length>1?oViewColInfo[1]:"");var Cols=grid.GetCols(""),Show="",Hide="";for(i=0;i<Cols.length;i++)vCol=grid.Cols[Cols[i]],vCol&&vCol.Sec==0&&(oVisible[vCol.Name]?Show+=","+vCol.Name:Hide+=","+vCol.Name);grid.ChangeColsVisibility(Show.substr(1).split(","),Hide.substr(1).split(","),0);for(oV in oVisible)if(ooV=oVisible[oV],ooV.Width!=""){tWidth=grid.GetAttribute(null,oV,"Width"),dx=parseInt(ooV.Width)-tWidth;try{grid.SetWidth(oV,dx)}catch(e){}}oView.Filters==""||oView.Filters=="||"?grid.ChangeFilter("","","",0,0,null):(filters=oView.Filters.split("|"),grid.ChangeFilter(filters[0],filters[1],filters[2],0,0,null)),grid.Sort=oView.Sort,grid.SortRows(),newobj.CurrentViewId=view,newobj.CurrentView=oView.Name,RefreshCommandUI(),grid.Render()}function DeleteView(n,t){ShowMessage(n.id,"Deleting View...",150,50),EPMLiveCore.WorkEngineAPI.ExecuteJSON("timesheet_DeleteView",'<View Name="'+t+'"/>',function(response){var oResponse=eval("("+response+")"),newgridid,newobj,view,oView;if(n.StaticCursor=1,HideMessage(n.id),oResponse.Views.Status=="0"){newgridid=n.id.substr(2),newobj=eval("TSObject"+newgridid),newobj.Views=eval("("+oResponse.Views.Text.replace(/&quot;/g,'"')+")");for(view in newobj.Views)oView=newobj.Views[view];newobj.CurrentView="",newobj.CurrentViewId="",RefreshCommandUI()}else alert(oResponse.Views.Text)})}function RenameView(n,t,i){ShowMessage(n.id,"Renaming View...",150,50),EPMLiveCore.WorkEngineAPI.ExecuteJSON("timesheet_RenameView",'<View Name="'+t+'" NewName="'+i+'"/>',function(response){var oResponse=eval("("+response+")"),newgridid,newobj,view,oView;if(n.StaticCursor=1,HideMessage(n.id),oResponse.Views.Status=="0"){newgridid=n.id.substr(2),newobj=eval("TSObject"+newgridid),newobj.Views=eval("("+oResponse.Views.Text.replace(/&quot;/g,'"')+")");for(view in newobj.Views)if(oView=newobj.Views[view],oView.Name==i){newobj.CurrentView=i,newobj.CurrentViewId=view;break}RefreshCommandUI()}else alert(oResponse.Views.Text)})}function SaveView(n,t){var o,s,i,e;ShowMessage(n.id,"Saving View...",150,50),n.StaticCursor=0;var l=n.GetRowById("Filter"),r="",u="",f="";for(o in n.Cols)s=l[o+"Filter"],s!=null&&s!=0&&(f+=","+s,u+=","+l[o],r+=","+o);f.length>0&&(f=f.substr(1)),u.length>0&&(u=u.substr(1)),r.length>0&&(r=r.substr(1));var a=r+"|"+u+"|"+f,h=n.GetCols("Visible"),c="";for(i=0;i<h.length;i++)e=n.Cols[h[i]],e&&e.Sec==0&&(c+=e.Name!="Title"?","+h[i]+"|"+e.Width:","+h[i]+"|");c=c.substr(1),EPMLiveCore.WorkEngineAPI.ExecuteJSON("timesheet_SaveView",'<View Name="'+t[0]+'" Default="'+t[1]+'" Filters="'+a+'" Group="'+n.Group+'" Sort="'+n.Sort+'" Cols="'+c+'" Expand="" />',function(response){var oResponse=eval("("+response+")"),newgridid,newobj,view,oView;if(n.StaticCursor=1,HideMessage(n.id),oResponse.Views.Status=="0"){newgridid=n.id.substr(2),newobj=eval("TSObject"+newgridid),newobj.Views=eval("("+oResponse.Views.Text.replace(/&quot;/g,'"')+")");for(view in newobj.Views)if(oView=newobj.Views[view],oView.Name==t[0]){newobj.CurrentView=t[0],newobj.CurrentViewId=view;break}RefreshCommandUI()}else alert(oResponse.Views.Text)})}function CheckApproveStatus(n){var t=Grids[n];EPMLiveCore.WorkEngineAPI.ExecuteJSON("timesheet_CheckApproveStatus",'<Timesheet ID="'+t.TimesheetUID+'" />',function(response){var oResponse=eval("("+response+")");if(oResponse.ApproveStatus.Result=="0"){var status="",newgridid=t.id.substr(2),newobj=eval("TSObject"+newgridid);oResponse.ApproveStatus.Status=="2"||oResponse.ApproveStatus.Status=="-1"?(TSApprovalMessage!=null&&(SP.UI.Status.removeStatus(TSApprovalMessage),TSApprovalMessage=null),oResponse.ApproveStatus.ApprovalStatus=="1"?newobj.Status="Approved":oResponse.ApproveStatus.ApprovalStatus=="2"&&(newobj.Status="Rejected"),bTSApproving&&(bTSApproving=!1,RefreshCommandUI())):(bTSApproving||(bTSApproving=!0,newobj.Status="Approving",RefreshCommandUI()),TSApprovalMessage==null?(TSApprovalMessage=SP.UI.Status.addStatus("Approval:","Your timesheet is currently being approved.",!0),SP.UI.Status.setStatusPriColor(TSApprovalMessage,"blue")):(SP.UI.Status.updateStatus(TSApprovalMessage,"Your timesheet is currently being approved."),SP.UI.Status.setStatusPriColor(TSApprovalMessage,"blue")))}else alert(oResponse.ApproveStatus.Text)})}function OpenPMApprovals(n){var r=Grids["TS"+n],t,i;curGrid=r,t=siteColUrl+"/Lists/My%20Timesheet/Project%20Manager%20Approval.aspx",i={url:t,showMaximized:!0,title:"Approvals",autoSize:!1},SP.UI.ModalDialog.showModalDialog(i)}function AutoAddWork(n){var t,r,i;ShowMessage(n.id,"Adding Work...",130,30),t="";for(r in n.Rows)i=n.Rows[r],i.Kind=="Data"&&i.Def.Name=="R"&&(t+=","+i.ListID+"."+i.ItemID);t.length>0&&(t=t.substr(1)),EPMLiveCore.WorkEngineAPI.ExecuteJSON("timesheet_AutoAddWork",'<Timesheet ID="'+n.TimesheetUID+'" Rows="'+t+'" />',function(response){var oResponse=eval("("+response+")");oResponse.AutoAddWork.Status=="0"?(HideMessage(n.id),CheckForUpdate(n)):(HideMessage(n.id),alert(oResponse.AutoAddWork.Text))})}function DoPopUp(grid,row,col){var image,strDivTag,strTypeDiv,pVal,oVal,iType,oType,notes;if(curRow!=row||curCol!=col||!curPop&&TSColType==2){curPop=!1,curRow&&curRow.Kind=="Data"&&curRow.id!="-1"&&curCol&&TSCols[curCol]&&grid.SetAttribute(curRow,curCol,"HtmlPrefix","",!0,!1),curRow=row,curCol=col,curGrid=grid;var newgridid=grid.id.substr(2),newobj=eval("TSObject"+newgridid),bLocked=!1;if(newobj.Locked&&(bLocked=!0),newobj.Status!="Unsubmitted"&&(bLocked=!0),grid.GetValue(row,"TSEnabled")!="1"&&(bLocked=!0),grid.GetAttribute(row,"CanEdit")=="0"&&(bLocked=!0),row&&row.Kind=="Data"&&row.id!="-1"&&col&&TSCols[col]&&row.Def.Name=="R")if(TSColType==1)TSNotes&&(pVal=grid.GetValue(row,"TS"+col),image="tsnonotes",pVal!=""&&(image="tsnotes"),grid.EndEdit(!0),strDivTag='<div style=\'position: absolute; margin-left: 65px; cursor:pointer; z-index: 999;\' onMouseDown="stopProp(event);" onClick="showNotes(event);"><img id="notesimg" class="transparentnotes" src="/_layouts/epmlive/images/'+image+'.png"><\/div><div id=\'NotesDiv\' style=\'z-index:999;position: absolute; margin-left: 65px; display:none; width:150px;height:100px;border: 1px solid black;background-color:#FFFFFF;cursor:pointer\' onClick="stopProp(event);"><textarea id=\'txtNotes\' style=\'z-index:999;width:140px;height:60px;border:0px;margin-bottom:5px\' onkeyup="stopProp(event);" onclick="stopProp(event);" onkeypress="stopProp(event);"',bLocked&&(strDivTag+=' disabled="disabled"'),strDivTag+=">"+pVal+'<\/textarea><br><input type="button" value="OK" onCLick="SaveNotes(event);stopProp(event);"><\/div>',grid.SetAttribute(row,col,"HtmlPrefix",strDivTag,!0,!1));else if(TSColType==2){curPop=!0,strTypeDiv='<div id=\'TypeDivOuter\' style=\'position: absolute; margin-top: 20px; margin-left: 2px; cursor:default; width:156px; background-color: #EAEAEA; text-align:left;border: 1px solid gray; padding:3px;\' onClick="stopProp(event);"><table border="0" cellspacing="3" cellpadding="0">',pVal=grid.GetValue(row,"TS"+col),pVal==""&&(pVal="{}"),oVal=eval("("+pVal+")");for(iType in TSTypeObject){oType=TSTypeObject[iType],strTypeDiv+="<tr><td>"+oType+':<\/td><td align="right"><input type="text" class="epmliveinput" onkeydown="stopProp(event);" onkeyup="stopProp(event);" onkeypress="stopProp(event);" onmousedown="this.focus();this.select();stopProp(event);" onmouseup="this.focus();this.select();stopProp(event);" onClick="this.focus();this.select();stopProp(event);" style="width:25px" id="'+iType+'TypeValue" Value="';try{strTypeDiv+=oVal[iType]?oVal[iType]:"0"}catch(e){}strTypeDiv+='"',bLocked&&(strTypeDiv+=' disabled="disabled"'),strTypeDiv+="><\/td><\/tr>"}TSNotes&&(notes="",oVal.Notes&&(notes=oVal.Notes,notes=unescape(notes).replace(/<br>/g,"\r\n")),strTypeDiv+='<tr><td colspan="2"><textarea class="epmliveinput" id=\'txtNotes\' style=\'width:140px;height:75px;\' ondblclick="stopProp(event);" onkeydown="stopProp(event);" onkeyup="stopProp(event);" onclick="stopProp(event);" onkeypress="stopProp(event);"',bLocked&&(strTypeDiv+=' disabled="disabled"'),strTypeDiv+=">"+notes+"<\/textarea><\/td><\/tr>"),strTypeDiv+='<tr><td colspan="2" align="right">',bLocked||(strTypeDiv+='<input type="button" value="OK" class="tsOK" onClick="SaveTypes(event);">&nbsp;'),strTypeDiv+='<input type="button" value="Cancel" class="tsOK" onClick="CloseTypes(event);"><\/td><\/tr><\/table><\/div><div style=\'position: absolute; margin-top: -10px; margin-left: -9px \'><img src=\'/_layouts/epmlive/images/tsoutline.png\'><\/div>',grid.SetAttribute(row,col,"HtmlPrefix",strTypeDiv,!0,!1),setTimeout("curGrid.StartEdit()",100)}}}function CheckForUpdate(n){var t,u,r,i;curGrid=n,ShowMessage(n.id,"Refreshing Timesheet",180,50),t="";for(u in n.Rows)r=n.Rows[u],r.Kind=="Data"&&r.Def.Name=="R"&&(t+=","+r.UID);t.length>0&&(t=t.substr(1)),i="&lt;Param",i+=' ID="'+n.TimesheetUID+'"',i+=' Rows="'+t+'"',i+="/&gt;",n.Data.Check.Param.Dataxml=i,n.CheckForUpdates(CheckedUpdates)}function CheckedUpdates(){var newgridid=curGrid.id.substr(2),newobj=eval("TSObject"+newgridid);ChangeView(curGrid,newobj.CurrentViewId),HideMessage(curGrid.id)}function StopStopWatchClose(oDialogResult){var oSW,SW,iType,fVal;if(oDialogResult==SP.UI.DialogResult.OK)if(TSColType==1)for(SW in StopWatchResponse)SW!="Status"&&(oSW=StopWatchResponse[SW],fVal=parseFloat(curStoppingGrid.GetValue(curStoppingRow,"P"+oSW.DateTicks)),isNaN(fVal)&&(fVal=0),fVal+=parseFloat(oSW.Minutes)/60,curStoppingGrid.SetValue(curStoppingRow,"P"+oSW.DateTicks,parseFloat(fVal.toFixed(2)),1,0));else if(TSColType==2)for(SW in StopWatchResponse)if(SW!="Status"){var oSW=StopWatchResponse[SW],pVal=curStoppingGrid.GetValue(curStoppingRow,"TSP"+oSW.DateTicks),oVal=null;pVal!=""&&(oVal=eval("("+pVal+")"));var fTotal=0,bSet=!1,newTypeVal="";for(iType in TSTypeObject)fVal=0,oVal&&oVal[iType]&&(fVal=oVal[iType]),bSet||(fVal+=parseFloat(oSW.Minutes)/60,bSet=!0),fVal!="NaN"&&fVal!=0&&(newTypeVal+=","+iType+": "+fVal.toFixed(2),fTotal+=fVal);TSNotes&&oVal&&oVal.Notes&&(newTypeVal+=',Notes: "'+oVal.Notes+'"'),newTypeVal.length>0&&(newTypeVal=newTypeVal.substr(1)),newTypeVal="{"+newTypeVal+"}",curStoppingGrid.SetValue(curStoppingRow,"P"+oSW.DateTicks,parseFloat(fTotal.toFixed(2)),1,0),curStoppingGrid.SetValue(curStoppingRow,"TSP"+oSW.DateTicks,newTypeVal,0,0)}bStopWatchStartWaiting&&(bStopWatchStartWaiting=!1,StartStopWatch(curGrid,curRow))}function StopStopWatch(grid,row){var newgridid=grid.id.substr(2),newobj=eval("TSObject"+newgridid);EPMLiveCore.WorkEngineAPI.ExecuteJSON("timesheet_StopStopWatch",'<StopWatch ID="'+row.UID+'" UserId="'+newobj.UserId+'"/>',function(response){var oResp=eval("("+response+")"),bApply,htmlP,oSW,htmlMsg,inp,inp2,options;if(oResp.StopWatch.Status=="0"){bApply=!1,htmlP=document.createElement("p"),htmlP.setAttribute("style","padding:10px"),htmlMsg=document.createTextNode("Would you like to apply the following to your timesheet: "),htmlP.appendChild(htmlMsg),htmlP.appendChild(document.createElement("br")),htmlP.appendChild(document.createElement("br")),StopWatchResponse=oResp.StopWatch;for(oSW in oResp.StopWatch)if(oSW!="Status"){var oSWV=oResp.StopWatch[oSW],oDate=new Date(oSWV.Date),oMinutes=oSWV.Minutes,oCol=grid.Cols["P"+oSWV.DateTicks];oCol&&(bApply=!0,htmlMsg=document.createTextNode(oDate.format("MMM dd")+": "+GetTimeDisplay(parseFloat(oMinutes)*6e4)),htmlP.appendChild(htmlMsg),htmlP.appendChild(document.createElement("br")))}bApply?(curStoppingGrid=grid,curStoppingRow=row,inp=document.createElement("input"),inp.setAttribute("type","button"),inp.setAttribute("value","Yes"),inp.setAttribute("onclick","SP.UI.ModalDialog.commonModalDialogClose(SP.UI.DialogResult.OK, 0);"),htmlP.appendChild(document.createElement("br")),htmlP.appendChild(document.createElement("br")),htmlP.appendChild(inp),inp2=document.createElement("input"),inp2.setAttribute("type","button"),inp2.setAttribute("value","No"),inp2.setAttribute("onclick","SP.UI.ModalDialog.commonModalDialogClose(SP.UI.DialogResult.Cancel, 0);"),htmlP.appendChild(inp2),options={title:"Confirm Hours",width:300,html:htmlP,dialogReturnValueCallback:StopStopWatchClose},SP.UI.ModalDialog.showModalDialog(options)):alert("There were no dates to apply to this period"),grid.SetAttribute(row,"StopWatch","Icon","/_layouts/epmlive/images/tstimeroff.png",!0,!1),StopWatchRow=null,grid.SetValue(row,"StopWatch","",1,0)}else alert(oResp.StopWatch.Text)})}function StartStopWatch(grid,row){var newgridid=grid.id.substr(2),newobj=eval("TSObject"+newgridid),url;IsLocked(grid)?alert("You cannot start a stop watch on a submitted timesheet"):newobj.IsCurPeriod?EPMLiveCore.WorkEngineAPI.ExecuteJSON("timesheet_StartStopWatch",'<StopWatch ID="'+row.UID+'" UserId="'+newobj.UserId+'"/>',function(response){var oResp=eval("("+response+")");oResp.StopWatch.Status=="0"?(grid.SetValue(row,"StopWatch",oResp.StopWatch.Text,1,0),grid.SetAttribute(row,"StopWatch","Icon","/_layouts/epmlive/images/tstimeron.png",!0,!1),StopWatchRow=row,StopWatchGrid=grid,RefreshStopWatch()):alert(oResp.StopWatch.Text)}):newobj.CurPeriodId==0?alert("You can only start stopwatches within the period that the current date resides and there seems to be no period setup for today's date."):confirm("You can only start stopwatches within the period that the current date resides. Would you like to switch to period: "+newobj.CurPeriodName+"?")&&(url=newobj.TSURL,url+=url.indexOf("?")>0?"&":"?",location.href=url+"NewPeriod="+newobj.CurPeriodId)}function getFormattedNumber(n){var i=Number("1.2").toLocaleString().substr(1,1),u=n.toLocaleString(),r=String(u).split(i),f=r[0],t=r.length>1?r[1]:"";return t=(t+"00").substr(0,2),parseInt(t)==0&&(t="",i=""),f+i+t}function GetTimeDisplay(n){var r=6e4,u=r*60,e=u*24,f=Math.floor(n/e),t,i,o;return n=n-f*e,t=Math.floor(n/u),n=n-t*u,i=Math.floor(n/r),n=n-i*r,o=Math.floor(n/1e3),f>0?f+"d "+t+"h "+i+"m":t>0?t+"h "+i+"m":i+"m"}function RefreshStopWatch(){StopWatchRow&&StopWatchGrid&&(StopWatchGrid.RefreshCell(StopWatchRow,"StopWatch"),setTimeout("RefreshStopWatch()",3e4))}function GetDecimalFromTime(n){var i=n.split(":"),r=StringToNumber(i[0]),t;return i.length>1&&(t=StringToNumber(i[1]),t=t/60,r+=t),parseFloat(r.toFixed(2))}function CloseTypes(n){curGrid.EndEdit(!1),curGrid.SetAttribute(curRow,curCol,"HtmlPrefix","",!0,!1),curPop=!1,stopProp(n)}function SaveTypes(n){var t,r,u,f,i;curGrid.EndEdit(!1),t="",r=0;for(u in TSTypeObject)f=document.getElementById(u+"TypeValue").value,f!=""&&(i=GetDecimalFromTime(f),i!="NaN"&&i!=0&&(t+=","+u+": "+i,r+=i));TSNotes&&(t+=',Notes: "'+escape(document.getElementById("txtNotes").value.replace(/\r\n/g,"<br>"))+'"'),t.length>0&&(t=t.substr(1)),t="{"+t+"}",curGrid.SetAttribute(curRow,curCol,"HtmlPrefix","",!0,!1),curGrid.SetValue(curRow,curCol,r,1,0),curGrid.SetValue(curRow,"TS"+curCol,t,0,0),curPop=!1,stopProp(n)}function SaveNotes(n){var t=document.getElementById("txtNotes").value,i;TSColType==1&&curGrid.SetValue(curRow,"TS"+curCol,t),document.getElementById("NotesDiv").style.display="none",i=document.getElementById("notesimg"),i.src=t==""?"/_layouts/epmlive/images/tsnonotes.png":"/_layouts/epmlive/images/tsnotes.png",stopProp(n)}function stopProp(n){n.stopPropagation?n.stopPropagation():window.event&&(window.event.cancelBubble=!0)}function showNotes(n){var i=document.getElementById("NotesDiv"),t;i.style.display="",t=document.getElementById("txtNotes"),t.focus(),stopProp(n)}function BeforeSave(n){if(typeof TimesheetBeforeSave=="function"){try{var t=TimesheetBeforeSave(n);return t.CanSave?!0:(alert(t.Message),!1)}catch(i){alert("Error Checking Save: "+i)}return!1}return!0}function AfterSave(n){if(typeof TimesheetAfterSave=="function")try{TimesheetAfterSave(n)}catch(t){alert("Error After Save: "+t)}}function BeforeSubmit(n){if(typeof TimesheetBeforeSubmit=="function"){try{var t=TimesheetBeforeSubmit(n);return t.CanSubmit?!0:(alert(t.Message),!1)}catch(i){alert("Error Checking Submit: "+i)}return!1}return!0}function IsLocked(grid){var newgridid=grid.id.substr(2),newobj=eval("TSObject"+newgridid);return newobj.Locked||bTSApproving?!0:newobj.Status!="Unsubmitted"?!0:!1}function AfterSubmit(n){if(typeof TimesheetAfterSubmit=="function")try{TimesheetAfterSubmit(n)}catch(t){alert("Error After Submit: "+t)}}function BeforeUnSubmit(n){if(typeof TimesheetBeforeUnSubmit=="function"){try{var t=TimesheetBeforeUnSubmit(n);return t.CanUnSubmit?!0:(alert(t.Message),!1)}catch(i){alert("Error Checking UnSubmit: "+i)}return!1}return!0}function AfterUnSubmit(n){if(typeof TimesheetAfterUnSubmit=="function")try{TimesheetAfterUnSubmit(n)}catch(t){alert("Error After UnSubmit: "+t)}}function fireEvent(n,t){var i;return document.createEventObject?(i=document.createEventObject(),n.fireEvent("on"+t,i)):(i=document.createEvent("HTMLEvents"),i.initEvent(t,!0,!0),!n.dispatchEvent(i))}function leavePage(){var n="";return curGrid.HasChanges()&&(n="You have unsaved changes."),n!=""?n:void 0}function ShowApprovalNotification(){EPMLiveCore.WorkEngineAPI.set_path(siteUrl+"/_vti_bin/WorkEngine.asmx"),EPMLiveCore.WorkEngineAPI.ExecuteJSON("timesheet_ShowApprovalNotification","<ApprovalNotification PeriodId='"+periodId+"' />",function(response){var oResp=eval("("+response+")");oResp.ApprovalNotification.Status=="0"&&oResp.ApprovalNotification.Text!="0"&&(updateStatusBox=SP.UI.Status.addStatus("Notification:","You have "+oResp.ApprovalNotification.Text+" timesheet(s) pending for approval <a href='#' onclick='Javascript:DoTmAprrovals();'>[Timesheet Manager]<\/a>",!0))})}function DoTmAprrovals(){var n=siteColUrl+"/Lists/My%20Timesheet/Timesheet%20Managers%20Approval.aspx",t={url:n,showMaximized:!0,title:"Approvals",autoSize:!1};SP.UI.ModalDialog.showModalDialog(t)}function showComments(n){var i=Grids[n],t=i.ARow,r=siteUrl+"/_layouts/epmlive/gridaction.aspx?action=comments&webid="+t.WebID+"&listid="+t.ListID+"&ID="+t.ItemID,u={title:"Comments",allowMaximize:!0,showClose:!0,url:r};SP.UI.ModalDialog.showModalDialog(u)}function previousPeriodCommand(n,t,i){if(t!="0"){var r=n;r+=r.indexOf("?")>0?"&NewPeriod="+t:"?NewPeriod="+t,i!=""&&(r+="&Delegate="+i),location.href=r}}function nextPeriodCommand(n,t,i){if(t!="0"){var r=n;r+=r.indexOf("?")>0?"&NewPeriod="+t:"?NewPeriod="+t,i!=""&&(r+="&Delegate="+i),location.href=r}}function changePeriodCommand(n,t,i){var r=n,u=t.options[t.selectedIndex].value;r+=r.indexOf("?")>0?"&NewPeriod="+u:"?NewPeriod="+u,i!=""&&(r+="&Delegate="+i),location.href=r}var curRow,curCol,TSColType,TSNotes,TSTypeObject,TSCols,curGrid,curPop=!1,StopWatchRow=null,StopWatchGrid=null,siteId,siteUrl,siteColUrl,periodId,sApplyDates="",curStoppingRow,curStoppingGrid,StopWatchResponse,bStopWatchStartWaiting=!1,cView,TSStatusMessage=null,TSApprovalMessage=null,bTSSaving=!1,bTSApproving=!1,iApproveInterval,curServerDate,spnMsg=null,bSaveAndSubmit=!1;Grids.OnRenderStart=function(grid){var newgridid,newobj,R,oRow;if(grid.id.substr(0,2)=="TS"){newgridid=grid.id.substr(2),newobj=eval("TSObject"+newgridid),newobj&&(grid.TSObject=newobj);for(R in grid.Rows)oRow=grid.Rows[R],oRow.Kind=="Data"&&grid.GetValue(oRow,"StopWatch")!=""&&(StopWatchRow=oRow,StopWatchGrid=grid);EPMLiveCore.WorkEngineAPI.set_path(siteUrl+"/_vti_bin/WorkEngine.asmx")}},Grids.OnScroll=function(n){curRow&&curRow.Kind=="Data"&&curRow.id!="-1"&&curCol&&TSCols[curCol]&&(n.SetAttribute(curRow,curCol,"HtmlPrefix","",!0,!1),curPop=!1)},Grids.OnKeyDown=function(n,t){if(t==46)return!0;curGrid=n,setTimeout("esGrid()",10)},Grids.OnEnterEdit=function(){curPop&&setTimeout("curGrid.StartEdit()",100)},Grids.OnKeyPress=function(){},Grids.OnDblClick=function(n,t){if(GridType=="0"){if(curPop)return!0;t.ItemTypeID=="1"?t.EditMode||editSaveRow(n.id,t.id):alert("You cannot edit this item.")}},Grids.OnAfterSave=function(n){n.id.substr(0,2)=="TS"&&((n.IO.Result=="0"||n.IO.Result=="2")&&(bTSSaving=!0,RefreshCommandUI(),CheckSaveStatus(n.id)),HideMessage(n.id))},Grids.OnFocus=function(n,t,i){curRow||(curRow=t),DoPopUp(n,t,i),t.ItemID&&(n.ActionClearSelection(),n.SelectRow(t)),RefreshCommandUI()},Grids.OnClick=function(n,t,i){curPop||DoPopUp(n,t,i)},Grids.OnIconClick=function(n,t,i,r){n.id.substr(0,2)=="TS"&&r<16&&i=="StopWatch"&&(StopWatchRow?StopWatchRow.UID==t.UID?confirm("Would you like to stop that stop watch now?")&&StopStopWatch(n,t):confirm("There is already a stop watch running. Would you like to stop that stopwatch and start this one?")?(curGrid=n,curRow=t,StopStopWatch(StopWatchGrid,StopWatchRow),bStopWatchStartWaiting=!0):bStopWatchStartWaiting:StartStopWatch(n,t))},Grids.OnValueChanged=function(n,t,i,r){var f,u;if(n.id.substr(0,2)=="TS"&&t&&t.Kind=="Data"&&t.id!="-1"&&i&&TSCols[i]&&(r.toString()==""&&(r="0"),f=GetDecimalFromTime(r),u=n.GetValue(t,i),f.toString()=="NaN"?(alert("That is not a valid entry."),r=u):r=f,TSDCols[i])){var e=TSDCols[i].split("|"),o=parseFloat(e[0]),s=parseFloat(e[1]);r>s&&(alert("You may only enter a maximum time of "+s+" hours"),r=u),r<o&&(alert("You must enter atleast time of "+o+" hours"),r=u)}return r},Grids.OnGetHtmlValue=function(n,t,i,r){if(n.id.substr(0,2)=="TS")if(i=="StopWatch"){if(StopWatchRow&&t.UID==StopWatchRow.UID){var f=new Date(r),e=new Date((new Date).getTime()-curServerDate),u=e.getTime()-f.getTime();return u<0?"0m":GetTimeDisplay(u)}}else if(TSCols[i]||i=="TSTotals")return r=="0"||r==""?"":getFormattedNumber(r.toLocaleString())},window.onbeforeunload=leavePage,$(function(){ExecuteOrDelayUntilScriptLoaded(ShowApprovalNotification,"sp.js")});
//# sourceMappingURL=MyTimesheet.min.js.map