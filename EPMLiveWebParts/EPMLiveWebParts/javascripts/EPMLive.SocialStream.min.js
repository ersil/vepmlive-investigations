(function(n,t,i,r){"use strict";var f=function(){var u=function(){var e={root:n("#epm-social-stream"),content:n(document.getElementById("s4-workspace")),pagination:n("#epm-social-stream div#epm-se-pagination span"),noActivity:n("#epm-social-stream div#epm-se-no-activity")},f={day:i.compile(n("script#epm-se-day-template").html()),thread:i.compile(n("script#epm-se-thread-template").html()),activity:i.compile(n("script#epm-se-activity-template").html()),_singleNonCommentThread:n("script#_epm-se-single-non-comment-thread").html(),_commentThread:n("script#_epm-se-comment-thread").html(),_generalThread:n("script#_epm-se-general-thread").html(),_threadInfo:n("script#_epm-se-thread-info").html(),_avatar:n("script#_epm-se-avatar").html(),_user:n("script#_epm-se-user").html(),_userPlain:n("script#_epm-se-user-plain").html(),_time:n("script#_epm-se-time").html(),_threadIcon:n("script#_epm-se-thread-icon").html(),_commentBox:n("script#_epm-se-comment-box").html()},u={apiUrl:"/"+window.epmLive.currentWebUrl.slice(1)+"/_vti_bin/SocialEngine.svc",pagination:{limit:10,offset:null,isLoading:!1},ui:{selectors:{newer:"ul.epm-se-newer-activities",older:"ul.epm-se-older-activities",latest:"ul.epm-se-newest-activities",showNewer:"div.epm-se-show-newer",showOlder:"div.epm-se-show-older",day:"div.epm-se-header h1",commentBox:"div.epm-se-comment-input"},classes:{placeholder:"epm-se-placeholder",expanded:"epm-se-expanded",active:"epm-se-active"}},moreActivityRequests:[],threadsWithAllActivities:[],firstTimeLoad:!0},l=function(){r.lang("en",{calendar:{lastDay:"[Yesterday -]  MMMM D",sameDay:"[Today -] MMMM D",nextDay:"[Tomorrow -] MMMM D",lastWeek:"[Last] dddd [-] MMMM D",nextWeek:"dddd [-] MMMM D",sameElse:"MMMM D YYYY"}})},v=function(){i.registerPartial("single-non-comment-thread",f._singleNonCommentThread);i.registerPartial("comment-thread",f._commentThread);i.registerPartial("general-thread",f._generalThread);i.registerPartial("thread-info",f._threadInfo);i.registerPartial("avatar",f._avatar);i.registerPartial("user",f._user);i.registerPartial("user-plain",f._userPlain);i.registerPartial("time",f._time);i.registerPartial("thread-icon",f._threadIcon);i.registerPartial("comment-box",f._commentBox)},y=function(){var f,i,o,r;t.subscribe("se.dataLoaded",function(n){b(n)});t.subscribe("se.dayLoaded",function(n,t){d.render(n,t)});t.subscribe("se.dayRendered",function(n,t,i){g.render(n,t,i)});t.subscribe("se.threadRendered",function(n,t,i,r){h.render(n,t,i,r)});t.subscribe("se.threadRendered",function(n,t,i,r){k.configureBox({element:r.parent().find("div.epm-se-comment-box[data-threadId='"+t.id+"']"),placeholder:"Share something...",thread:t,$thread:r})});e.root.on("mouseenter",".epm-se-has-tooltip",function(){s.showTooltip(n(this))});for(e.content.scroll(function(){s.paginate()}),f=["a.epm-se-link-list","a.epm-se-link-item","a.epm-se-link-user"],i=0;i<f.length;i++)e.root.on("click",f[i],function(t){s.navigate(n(this));t.preventDefault()});for(o=[u.ui.selectors.showOlder,u.ui.selectors.showNewer],r=0;r<o.length;r++)e.root.on("click",o[r],function(){s.loadMore(n(this))})},p=function(){l();v();y()},a=function(i){var r,o,f;if(u.pagination.isLoading=!0,r=u.apiUrl+"/activities",i){r+="?";o=[];for(f in i)i.hasOwnProperty(f)&&o.push(f+"="+i[f]);r+=o.join("&")}n.getJSON(r).then(function(n){e.pagination.hide();t.publish("se.dataLoaded",n);u.pagination.offset=n.meta.offset;u.pagination.isLoading=!1;u.firstTimeLoad&&n.activities.length===0&&e.noActivity.fadeIn("fast");u.firstTimeLoad=!1})},w=function(t,i){var f,e,r;i.loader.text("loading...");f=u.apiUrl+"/thread/"+t.threadId+"?";e=[];for(r in t)t.hasOwnProperty(r)&&r!=="threadId"&&e.push(r+"="+t[r]);f+=e.join("&");n.getJSON(f).then(function(n){h.addMore(n,i.list,t.maxDate?"older":"newer");i.loader.fadeOut("fast").remove();i.list.fadeIn("fast")})},b=function(n){for(var i=0;i<n.days.length;i++)t.publish("se.dayLoaded",n.days[i],n)},k=function(){var t=function(n){n.input.addClass(u.ui.classes.placeholder);n.input.html(n.placeholder)},r=function(n){n.input.removeClass(u.ui.classes.placeholder);n.input.html("")},i=function(n){n.input.removeClass(u.ui.classes.expanded);n.button.hide();n.button.removeClass(u.ui.classes.active)},f=function(f){f.input.focus(function(){n(this).html()===f.placeholder&&r(f);f.input.addClass(u.ui.classes.expanded);f.button.show()});f.input.blur(function(){var r=n(this).html();(r===""||r==="<br>")&&t(f);u.lastClickedElement.id!==f.button.get(0).id&&i(f)});f.input.keyup(function(){var t=n(this).html();t!==""&&t!=="<br>"&&t!==f.placeholder?f.button.addClass(u.ui.classes.active):f.button.removeClass(u.ui.classes.active)});f.button.click(function(r){(r.preventDefault(),n(this).hasClass(u.ui.classes.active))&&(h.addComment({text:f.input.html(),thread:f.thread,$thread:f.$thread}),t(f),i(f))});e.root.mousedown(function(n){u.lastClickedElement=n.target})},o=function(n){n.input=n.element.find(u.ui.selectors.commentBox);n.button=n.element.find("button");t(n);f(n)};return{configureBox:o}}(),o=function(){var n=function(n,t){for(var i,f,u,r=0;r<t.length;r++)if(i=t[r],i.id===n){f={};for(u in i)i.hasOwnProperty(u)&&(f[u]=i[u]);return f}return null};return{getById:n}}(),c=function(){var n=function(n){return n.id===parseInt(window.epmLive.currentUserId)?"You":n.name.split(" ")[0]},t=function(n){return n.id===parseInt(window.epmLive.currentUserId)?"You":n.name},i=function(n){return window.epmLive.currentWebUrl+"/_layouts/15/userdisp.aspx?ID="+n.id};return{getDisplayName:n,getFullDisplayName:t,getUrl:i}}(),d=function(){var n=e.root.find("ul#epm-se-days"),i=function(i,r){i.domId=i.id.split("T")[0];var u=n.find("li#epm-se-"+i.domId);u.length?t.publish("se.dayRendered",i,r,u):(i.day=s.getLocalTime(i.id).calendar(),n.append(f.day(i)),t.publish("se.dayRendered",i,r,n.find("li#epm-se-"+i.domId)))};return{render:i}}(),h=function(){var e=function(activity){return activity.kind==="BULKOPERATION"?"updated "+eval("("+activity.metaData+")").totalActivities:activity.kind.toLowerCase()},t=function(n,t){var i=t?n.time:s.getLocalTime(n.time);return r.lang("en",{calendar:{lastDay:"[Yesterday]  MMM D",sameDay:"[Today] MMM D",nextDay:"[Tomorrow] MMM D",lastWeek:"[Last] ddd MMM D",nextWeek:"ddd MMM D",sameElse:"MMMM D YYYY"}}),i=i.calendar(),l(),i},i=function(n){return s.getLocalTime(n.time).format("LLLL")},h=function(n){switch(n.kind){case"CREATED":return"icon-plus-2";case"UPDATED":return"icon-pencil";default:return null}},a=function(activity){switch(activity.kind){case"CREATED":return"created this item";case"UPDATED":return"made an update";case"COMMENTADDED":return eval("("+activity.metaData+")").comment;default:return null}},n=function(n,r){var u=n;return u.id||(u=o.getById(n,r.activities)),u.text=a(u),u.icon=h(u),u.displayTime=t(u),u.user=o.getById(u.user,r.users),u.user.displayName=c.getFullDisplayName(u.user),u.user.url=c.getUrl(u.user),u.longDateTime=i(u),u.notComment=u.kind!=="COMMENTADDED",u},v=function(t,i,r){for(var e,o,s=i.parent(),u=0;u<t.activities.length;u++)e=t.activities[u],s.find("li#epm-se-"+e.id).length||(o=n(e,t),r==="older"?i.prepend(f.activity(o)).fadeIn("fast"):i.append(f.activity(o)).fadeIn("fast"))},y=function(t,i,r,e){for(var b,o,d,s,nt,a=!1,v=!1,h="",c="",y=e.find("ul.epm-se-todays-activities"),p=e.find(u.ui.selectors.older),l=0;l<t.todaysActivities.length;l++){var w=t.todaysActivities[l],tt="ul.epm-se-todays-activities li#epm-se-"+w,it=e.find(tt);it.length||(b=n(w,r),h+=f.activity(b))}for(o=0;o<t.previousActivities.length;o++){a=!0;var k=t.previousActivities[o],rt="ul.epm-se-previous-activities li#epm-se-"+k,ut=e.find(rt);ut.length||(d=n(k,r),c+=f.activity(d))}for(s=0;s<t.newerActivities.length;s++){v=!0;var g=t.newerActivities[s],ft="ul.epm-se-newer-activities li#epm-se-"+g,et=e.find(ft);et.length||(nt=n(g,r),e.find(u.ui.selectors.newer).append(f.activity(nt)))}u.firstTimeLoad?(y.append(h).fadeIn("fast"),p.append(c)):(y.prepend(h).fadeIn("fast"),p.prepend(c));a&&e.find(u.ui.selectors.showOlder).fadeIn("fast");v&&e.find(u.ui.selectors.showNewer).fadeIn("fast")},p=function(n){var e=r().tz(window.epmLive.currentUserTimeZone.olsonName),i={text:n.text,notComment:!1,time:e,longDateTime:e.format("LLLL"),user:{displayName:window.epmLive.currentUserDisplayName,avatar:window.epmLive.currentUserAvatar,url:window.epmLive.currentWebUrl+"/_layouts/15/userdisp.aspx?ID="+window.epmLive.currentUserId}};i.displayTime=t(i,!0);n.$thread.find(u.ui.selectors.latest).append(f.activity(i))};return{render:y,getAction:e,getDisplayTime:t,getLongTime:i,addMore:v,addComment:p}}(),g=function(){var n=function(n,t){return n.activity=o.getById(n.activities[0],t.activities),n.isCommentThread=!n.list&&!n.activity.itemId,n.isSingleNonCommentThread=!n.isCommentThread&&n.activities.length===1&&n.activity.kind!=="COMMENTADDED",n.isBulkOperationThread=n.activity.kind==="BULKOPERATION",n.activity.action=h.getAction(n.activity),n.activity.displayTime=h.getDisplayTime(n.activity),n.activity.longDateTime=h.getLongTime(n.activity),n.user=o.getById(n.activity.user,t.users),n.user.displayName=n.isCommentThread?c.getFullDisplayName(n.user):c.getDisplayName(n.user),n.user.url=c.getUrl(n.user),n.web=o.getById(n.web,t.webs),n.web.isCurrentWorkspace=n.web.id.toLowerCase()===window.epmLive.currentWebId.toLowerCase(),n.list=o.getById(n.list,t.lists),n.icon=n.list.icon||"icon-square",n},i=function(i,r,u,e,o){var s=r,h;s.domId="ul li#epm-se-"+s.id;h=o.find(s.domId);h.length?t.publish("se.threadRendered",i,s,e,h):(s=n(s,e),o.find("ul.epm-se-threads").append(f.thread(s)).fadeIn("fast"),t.publish("se.threadRendered",i,s,e,o.find(s.domId)))},r=function(n,t,r){for(var f,e,u=0;u<n.activityThreads.length;u++)f=o.getById(n.activityThreads[u],t.activityThreads),e=o.getById(f.thread,t.threads),i(f,e,n,t,r)};return{render:r}}(),s=function(){var t=function(n){n.tooltip("show")},i=function(n){OpenCreateWebPageDialog(n.data("url"))},f=function(){if(n("#epm-social-stream div#epm-se-pagination").offset().top<n(window).height()){var t=u.pagination;if(t.isLoading)return;if(!t.offset)return;e.pagination.show();a({limit:t.limit,offset:t.offset})}},o=function(n){var s=n.data("threadid"),e=u.ui.selectors,h=n.data("action"),t=n.parent(),o=t.parent().parent().data("date"),i,f={threadId:s};h==="newer"?(i=t.find(e.newer),f.minDate=r(o).add("days",1).format("YYYY-MM-DDT00:00:00")):(i=t.find(e.older),f.maxDate=o);w(f,{list:i,loader:n})},s=function(n){if(window.epmLive.currentUserTimeZone)try{return r.tz(n,window.epmLive.currentUserTimeZone.olsonName)}catch(t){window.epmLive.debugMode&&console.log(t.message)}return n};return{showTooltip:t,navigate:i,paginate:f,loadMore:o,getLocalTime:s}}();return{configure:p,load:a}}();u.configure();u.load({limit:20})},u=function(){window.epmLive?f():window.setTimeout(function(){u()},1)};n(function(){u()})})(jQuery,amplify,Handlebars,moment);
/*
//# sourceMappingURL=EPMLive.SocialStream.min.js.map
*/