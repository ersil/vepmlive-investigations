(function(n,t,i,r){"use strict";var f=function(){var u=function(){function v(){r.lang("en",{calendar:{lastDay:"[Yesterday -]  MMMM D",sameDay:"[Today -] MMMM D",nextDay:"[Tomorrow -] MMMM D",lastWeek:"[Last] dddd [-] MMMM D",nextWeek:"dddd [-] MMMM D",sameElse:"MMMM D YYYY"}})}function w(){i.registerPartial("user-avatar",f._userAvatar);i.registerPartial("thread-icon",f._threadIcon);i.registerPartial("thread-title",f._threadTitle);i.registerPartial("thread-info",f._threadInfo);i.registerPartial("activity-icon",f._activityIcon);i.registerPartial("user-info",f._userInfo);i.registerPartial("activity-info",f._activityInfo);i.registerPartial("activity-time",f._activityTime);i.registerPartial("object-info",f._objectInfo);i.registerPartial("comment-box",f._commentBox);l.configureBox({element:e.statusUpdateBox,placeholder:"Share something..."})}function b(n){for(var i=0;i<n.threads.length;i++)t.publish("se.threadLoaded",n.threads[i],n)}function k(){t.subscribe("se.dataLoaded",function(n){b(n)});t.subscribe("se.threadLoaded",function(n,t){p.render(n,t)});t.subscribe("se.threadRendered",function(n,t,i){s.render(n,t,i);l.render(n,t,i);l.configureBox({element:t.parent().find("div.epm-se-comment-box[data-threadId='"+n.id+"']"),placeholder:"Add a comment...",thread:n,$thread:t})});t.subscribe("se.olderactivitiesLoaded",function(n){s.renderOlder(n)});t.subscribe("se.oldercommentsLoaded",function(n){l.renderOlder(n)});e.root.on("mouseenter",".epm-se-has-tooltip",function(){h.showTooltip(n(this))});e.root.on("click","a.epm-se-link",function(t){h.navigate(n(this),t)});e.root.on("click",".epm-show-older",function(){h.showOlder(n(this))});e.content.scroll(function(){h.paginate()})}var a=window.epmLive.currentWebUrl.slice(1),u={pagination:{isLoading:!1,firstTimeLoad:!0,page:1,limit:10,activityLimit:1,commentLimit:2},ui:{selectors:{comments:"div.epm-se-comments",commentBox:"div.epm-se-comment-input",latestComments:"ul.epm-se-latest-comments"},classes:{placeholder:"epm-se-placeholder",expanded:"epm-se-expanded",active:"epm-se-active",hidden:"epm-se-hidden"}},apiUrl:"/"+a+"/_vti_bin/SocialEngine.svc",commentServiceUrl:"/"+a+"/_layouts/15/epmlive/CommentsProxy.aspx"},e={root:n("#epm-social-stream"),content:n(document.getElementById("s4-workspace")),pagination:n("#epm-social-stream div#epm-se-pagination span"),noActivity:n("#epm-social-stream div#epm-se-no-activity"),threads:n("#epm-social-stream ul#epm-se-threads"),statusUpdateBox:n("#epm-social-stream div#epm-se-status-update-box")},f={thread:i.compile(n("script#epm-se-thread-template").html()),activity:i.compile(n("script#epm-se-activity-template").html()),comment:i.compile(n("script#epm-se-comment-template").html()),_userAvatar:i.compile(n("script#_epm-se-user-avatar-template").html()),_threadIcon:i.compile(n("script#_epm-se-thread-icon-template").html()),_threadTitle:i.compile(n("script#_epm-se-thread-title-template").html()),_threadInfo:i.compile(n("script#_epm-se-thread-info-template").html()),_activityIcon:i.compile(n("script#_epm-se-activity-icon-template").html()),_userInfo:i.compile(n("script#_epm-se-user-info-template").html()),_activityInfo:i.compile(n("script#_epm-se-activity-info-template").html()),_activityTime:i.compile(n("script#_epm-se-activity-time-template").html()),_objectInfo:i.compile(n("script#_epm-se-object-info-template").html()),_commentBox:i.compile(n("script#_epm-se-comment-box-template").html())},o=function(){function n(n){if(window.epmLive.currentUserTimeZone)try{return r.tz(n,window.epmLive.currentUserTimeZone.olsonName)}catch(t){window.epmLive.debugMode&&console.log(t.message)}return n}var t=function(t,i){var u=i?t:n(t);return r.lang("en",{calendar:{lastDay:"[Yesterday]  MMM D",sameDay:"[Today] MMM D",nextDay:"[Tomorrow] MMM D",lastWeek:"[Last] ddd MMM D",nextWeek:"ddd MMM D",sameElse:"MMMM D YYYY"}}),u=u.calendar(),v(),u},i=function(t){return n(t).format("LLLL")},u=function(n){return parseInt(window.epmLive.currentUserId)===n.id?"You":n.displayName},f=function(n){return window.epmLive.currentWebUrl+"/_layouts/15/userdisp.aspx?ID="+n.id},e=function(n){n.length&&n.sort(function(n,t){return n&&t?n.time>t.time:!0})};return{getFriendlyTime:t,getLongTime:i,getUserFriendlyName:u,getUserProfileUrl:f,sortComments:e}}(),h=function(){var i=function(n,t){var i=n.data("kind");i!=="Workspace"&&(t.preventDefault(),OpenCreateWebPageDialog(n.attr("href")))},r=function(n){n.tooltip("show")},f=function(i){var r=i.data("kind"),f=u.apiUrl+"/thread/"+i.data("threadid")+"/"+r+"?offset="+i.data("offset");i.parent().find("ul.epm-se-older-"+r).show();i.remove();n.getJSON(f).then(function(n){n.threads[0][r].length&&t.publish("se.older"+r+"Loaded",n)})},o=function(){if(n("#epm-social-stream div#epm-se-pagination").offset().top<n(window).height()){if(u.pagination.isLoading)return;if(u.pagination.page===0)return;e.pagination.show();y()}};return{navigate:i,showTooltip:r,showOlder:f,paginate:o}}(),c=function(){var n=function(n,t){for(var i,f,u,r=0;r<t.length;r++)if(i=t[r],i.id===n){f={};for(u in i)i.hasOwnProperty(u)&&(f[u]=i[u]);return f}return null};return{getById:n}}(),p=function(){function i(t,i){var f="1986-11-06T13:03:00",r={time:f},e={time:f},o,s;return(t.activities.length&&(r=t.activities[0]),t.comments.length&&(e=t.comments[t.comments.length-1]),r.time===f&&e.time===f)?!1:(o=!1,r.time>e.time?s=r:(s=e,o=!0),t.user=c.getById(s.userId,i.users),t.kind==="Workspace"?t.icon="icon-tree-2":t.kind==="StatusUpdate"?t.icon="icon-bubble-12":(t.list=c.getById(t.listId,i.lists),t.list.icon=t.list.icon||"icon-square",t.icon=t.list.icon,window.epmLive.currentWebId!==t.webId&&(r.web=c.getById(t.webId,i.webs))),t.hasMoreActivities=o?t.totalActivities>=u.pagination.activityLimit:t.totalActivities>u.pagination.activityLimit,t.hasMoreComments=t.totalComments>u.pagination.commentLimit,t.commentsHidden=t.totalComments>0?"":"epm-se-hidden",t.activities.length&&(t.earliestActivityTime=t.activities[t.activities.length-1].time),t.comments.length&&(t.earliestCommentTime=t.comments[0].time),t.title=n("<div/>").html(n("<div/>").html(t.title).text()).text(),t)}var r=function(n,r){var u="li#epm-se-thread-"+n.id,s=e.threads.find(u);s.length?t.publish("se.threadRendered",n,s,r):(o.sortComments(n.comments),(n=i(n,r))&&(r.statusUpdate?e.threads.prepend(f.thread(n)):e.threads.append(f.thread(n)),t.publish("se.threadRendered",n,e.threads.find(u),r)))};return{render:r}}(),s=function(){function e(n,u,f){if(u.comments.length){var e=u.comments[u.comments.length-1];e.time>n.time&&(n=e,n.icon="icon-bubble-12",n.action="made a comment")}return n.icon||(n=t(n,u)),n=i(n,f),r(n)}function s(n,u,f){return n=t(n,u),n=i(n,f),r(n)}function h(n,t,i){var r=n.activities[0],u="ul.epm-se-activities li#epm-se-activity-"+r.id,o=t.find(u);o.length||(r=e(r,n,i))&&t.find("ul.epm-se-activities").append(f.activity(r))}function u(n,t,i){for(var u=0;u<n.activities.length;u++){var r=n.activities[u],e="ul.epm-se-activities li#epm-se-activity-"+r.id,o=t.find(e);o.length||(e="ul.epm-se-older-activities li#epm-se-activity-"+r.id,o=t.find(e),o.length||(r=s(r,n,i))&&t.find("ul.epm-se-older-activities").append(f.activity(r)))}}var l=function(n,t,i){h(n,t,i);u(n,t,i)},a=function(t){var i=t.threads[0],r=n("li#epm-se-thread-"+i.id);u(i,r,t)},t=function(n,t){if(t.kind==="StatusUpdate")n.icon="icon-bubble-12",n.action="made a comment";else{var i=(t.kind==="ListItem"?"item":t.kind).toLowerCase();switch(n.kind){case"Created":n.icon="icon-plus-2";n.action="created this "+i;break;case"Updated":n.icon="icon-pencil";n.action="made an update"}}return n},i=function(n,t){return n.user=c.getById(n.userId,t.users),n.user.friendlyName=o.getUserFriendlyName(n.user),n.user.profileUrl=o.getUserProfileUrl(n.user),n},r=function(n){return n.friendlyTime=o.getFriendlyTime(n.time),n.longTime=o.getLongTime(n.time),n};return{render:l,renderOlder:a,setIconAndAction:t,setUser:i,setTime:r}}(),l=function(){function c(comment,thread,data){return comment=s.setIconAndAction(comment,thread),comment=s.setUser(comment,data),comment=s.setTime(comment),comment.text=eval("("+comment.data+")").comment,comment}function i(n,t,i,r){var u;for(o.sortComments(n.comments),u=0;u<n.comments.length;u++){var e=n.comments[u],s="ul.epm-se-comments li#epm-se-comment-"+e.id,h=t.find(s);h.length||(e=c(e,n,i))&&t.find(r?"ul.epm-se-older-comments":"ul.epm-se-comments").append(f.comment(e))}}function t(n){n.input.addClass(u.ui.classes.placeholder);n.input.html(n.placeholder)}function l(n){n.input.removeClass(u.ui.classes.placeholder);n.input.html("")}function h(n){n.input.removeClass(u.ui.classes.expanded);n.button.hide();n.button.removeClass(u.ui.classes.active)}function a(n){var t=r().tz(window.epmLive.currentUserTimeZone.olsonName),i={id:(new Date).getTime(),text:n.text,friendlyTime:o.getFriendlyTime(t,!0),longTime:t.format("LLLL"),user:{friendlyName:"You",picture:window.epmLive.currentUserAvatar,profileUrl:window.epmLive.currentWebUrl+"/_layouts/15/userdisp.aspx?ID="+window.epmLive.currentUserId}};n.$thread&&(n.$thread.find(u.ui.selectors.latestComments).append(f.comment(i)),n.$thread.find(u.ui.selectors.comments).removeClass(u.ui.classes.hidden))}function v(t){var i=0,r=null;t.thread&&(i=t.thread.itemId);i!==0?r=t.thread.listId:i=null;n.post(u.commentServiceUrl,{command:"CreateComment",comment:t.text,newcomment:null,itemId:i,listId:r,userId:window.epmLive.currentUserId,commentItemId:i,kind:t.thread.kind,suid:t.thread.activities[0].key}).then(function(n){console.log(n)})}function y(i){i.input.focus(function(){n(this).html()===i.placeholder&&l(i);i.input.addClass(u.ui.classes.expanded);i.button.show()});i.input.blur(function(){var r=n(this).html();(r===""||r==="<br>")&&t(i);u.lastClickedElement.id!==i.button.get(0).id&&h(i)});i.input.keyup(function(){var t=n(this).html();t!==""&&t!=="<br>"&&t!==i.placeholder?i.button.addClass(u.ui.classes.active):i.button.removeClass(u.ui.classes.active)});i.button.click(function(r){if(r.preventDefault(),n(this).hasClass(u.ui.classes.active)){var f={text:n.trim(i.input.text()),thread:i.thread,$thread:i.$thread};f.text.length!==0&&(a(f),t(i),h(i),v(f))}});e.root.mousedown(function(n){u.lastClickedElement=n.target})}var p=function(n,t,r){i(n,t,r)},w=function(t){var r=t.threads[0],u=n("li#epm-se-thread-"+r.id);i(r,u,t,!0)},b=function(n){n.input=n.element.find(u.ui.selectors.commentBox);n.button=n.element.find("button");t(n);y(n)};return{render:p,renderOlder:w,configureBox:b}}(),d=function(){v();w();k()},y=function(i){var f,o,r;if(u.pagination.page!==0){i=i||{page:u.pagination.page,limit:u.pagination.limit,activityLimit:u.pagination.activityLimit,commentLimit:u.pagination.commentLimit};u.pagination.isLoading=!0;f=u.apiUrl+"/activities?";o=[];for(r in i)i.hasOwnProperty(r)&&o.push(r+"="+i[r]);f+=o.join("&");n.getJSON(f).then(function(n){e.pagination.hide();n.threads.length?(t.publish("se.dataLoaded",n),u.pagination.page++):u.pagination.page=0;u.pagination.isLoading=!1;u.pagination.firstTimeLoad&&n.threads.length===0&&e.noActivity.fadeIn("fast");u.pagination.firstTimeLoad=!1})}};return{configure:d,load:y}}();u.configure();u.load()},u=function(){window.epmLive?f():window.setTimeout(function(){u()},1)};n(function(){u()})})(jQuery,amplify,Handlebars,moment);
/*
//# sourceMappingURL=EPMLive.SocialStream.min.js.map
*/